# üß± –û—Å–Ω–æ–≤—ã aiogram 3.x

## üìë –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–í–≤–µ–¥–µ–Ω–∏–µ](#–≤–≤–µ–¥–µ–Ω–∏–µ)
2. [–ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è aiogram](#–∏—Å—Ç–æ—Ä–∏—è%20—Ä–∞–∑–≤–∏—Ç–∏—è%20aiogram)
3. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ aiogram 3.x](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞%20aiogram%203.x)
   - [–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã](#–æ—Å–Ω–æ–≤–Ω—ã–µ%20–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
   - [–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤](#–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ%20–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)
   - [–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å aiogram 2.x](#—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ%20—Å%20aiogram%202.x)
4. [Dispatcher - —Å–µ—Ä–¥—Ü–µ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞](#dispatcher%20-%20—Å–µ—Ä–¥—Ü–µ%20–≤–∞—à–µ–≥–æ%20–±–æ—Ç–∞)
   - [–ß—Ç–æ —Ç–∞–∫–æ–µ Dispatcher?](#—á—Ç–æ%20—Ç–∞–∫–æ–µ%20dispatcher)
   - [–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è](#–∂–∏–∑–Ω–µ–Ω–Ω—ã–π%20—Ü–∏–∫–ª%20–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
   - [–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã Dispatcher](#–æ—Å–Ω–æ–≤–Ω—ã–µ%20–º–µ—Ç–æ–¥—ã%20dispatcher)
   - [–í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ](#–≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ%20—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ)
   - [–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏](#–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ%20–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)
5. [Bot - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫ Telegram API](#bot%20-%20–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å%20–∫%20telegram%20api)
   - [–ß—Ç–æ —Ç–∞–∫–æ–µ Bot?](#—á—Ç–æ%20—Ç–∞–∫–æ–µ%20bot)
   - [–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã Bot](#–æ—Å–Ω–æ–≤–Ω—ã–µ%20–º–µ—Ç–æ–¥—ã%20bot)
   - [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Bot](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞%20bot)
   - [–†–∞–±–æ—Ç–∞ —Å —Å–µ—Å—Å–∏—è–º–∏](#—Ä–∞–±–æ—Ç–∞%20—Å%20—Å–µ—Å—Å–∏—è–º–∏)
   - [–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫](#–æ–±—Ä–∞–±–æ—Ç–∫–∞%20–æ—à–∏–±–æ–∫)
6. [Router - –æ—Ä–≥–∞–Ω–∏–∑—É–µ–º –∫–æ–¥ –ª–æ–≥–∏—á–Ω–æ](#router%20-%20–æ—Ä–≥–∞–Ω–∏–∑—É–µ–º%20–∫–æ–¥%20–ª–æ–≥–∏—á–Ω–æ)
   - [–ß—Ç–æ —Ç–∞–∫–æ–µ Router?](#—á—Ç–æ%20—Ç–∞–∫–æ–µ%20router)
   - [–ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã](#–ø—Ä–∏–Ω—Ü–∏–ø—ã%20—Ä–∞–±–æ—Ç—ã)
   - [–°–æ–∑–¥–∞–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Router](#—Å–æ–∑–¥–∞–Ω–∏–µ%20–∏%20–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ%20router)
   - [–í–ª–æ–∂–µ–Ω–Ω—ã–µ —Ä–æ—É—Ç–µ—Ä—ã](#–≤–ª–æ–∂–µ–Ω–Ω—ã–µ%20—Ä–æ—É—Ç–µ—Ä—ã)
   - [–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏](#–ª—É—á—à–∏–µ%20–ø—Ä–∞–∫—Ç–∏–∫–∏)
7. [–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –≤ aiogram](#–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å%20–≤%20aiogram)
   - [–ü–æ—á–µ–º—É –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–∞?](#–ø–æ—á–µ–º—É%20–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å%20–≤–∞–∂–Ω–∞)
   - [–û—Å–Ω–æ–≤—ã async/await](#–æ—Å–Ω–æ–≤—ã%20async/await)
   - [Event Loop](#event%20loop)
   - [–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –≤ aiogram](#–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å%20–≤%20aiogram)
   - [–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å](#–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
   - [–¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏](#—Ç–∏–ø–∏—á–Ω—ã–µ%20–æ—à–∏–±–∫–∏)
8. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞%20–ø—Ä–æ–µ–∫—Ç–∞)
   - [–ü–æ—á–µ–º—É –≤–∞–∂–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞?](#–ø–æ—á–µ–º—É%20–≤–∞–∂–Ω–∞%20—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
   - [–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞](#—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è%20—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
   - [–ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#–ø—Ä–∏–º–µ—Ä%20—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
   - [–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ](#–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ)
9. [Dependency Injection (DI)](#dependency%20injection%20(di))
   - [–ß—Ç–æ —Ç–∞–∫–æ–µ DI?](#—á—Ç–æ%20—Ç–∞–∫–æ–µ%20di)
   - [–ü—Ä–∏–Ω—Ü–∏–ø—ã DI](#–ø—Ä–∏–Ω—Ü–∏–ø—ã%20di)
   - [DI –≤ aiogram](#di%20–≤%20aiogram)
   - [–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã](#–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ%20–ø—Ä–∏–º–µ—Ä—ã)
   - [–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã](#–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ%20–ø–∞—Ç—Ç–µ—Ä–Ω—ã)
10. [–ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∫–æ–¥–∞](#–ø–æ–ª–Ω—ã–π%20–ø—Ä–∏–º–µ—Ä%20–∫–æ–¥–∞)
11. [–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è](#–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å%20–∏%20–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
    - [–ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ](#–ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ)
    - [–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤](#–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è%20–∑–∞–ø—Ä–æ—Å–æ–≤)
    - [–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ](#–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ)
12. [–¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏–µ](#—Ç–∏–ø–∏—á–Ω—ã–µ%20–æ—à–∏–±–∫–∏%20–∏%20–∏—Ö%20—Ä–µ—à–µ–Ω–∏–µ)
13. [–ó–∞–∫–ª—é—á–µ–Ω–∏–µ](#–∑–∞–∫–ª—é—á–µ–Ω–∏–µ)

---

## üìñ –í–≤–µ–¥–µ–Ω–∏–µ

–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∞–º—É—é –≤–∞–∂–Ω—É—é –≥–ª–∞–≤—É –Ω–∞—à–µ–≥–æ —É—á–µ–±–Ω–∏–∫–∞! –ï—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≥–ª–∞–≤—ã –±—ã–ª–∏ –ø–æ—Å–≤—è—â–µ–Ω—ã –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–º—É —Å–æ–∑–¥–∞–Ω–∏—é –±–æ—Ç–æ–≤, —Ç–æ —Ç–µ–ø–µ—Ä—å –º—ã –ø–æ–≥—Ä—É–∑–∏–º—Å—è –≤ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å–Ω–æ–≤—ã aiogram 3.x. –ü–æ–Ω–∏–º–∞–Ω–∏–µ —ç—Ç–∏—Ö –∫–æ–Ω—Ü–µ–ø—Ü–∏–π ‚Äî —ç—Ç–æ —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —Ç–µ–º, –∫—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø–∏—à–µ—Ç –∫–æ–¥, –∏ —Ç–µ–º, –∫—Ç–æ —Å–æ–∑–¥–∞–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã–µ, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ä–µ—à–µ–Ω–∏—è.

**–í —ç—Ç–æ–π –≥–ª–∞–≤–µ –≤—ã —É–∑–Ω–∞–µ—Ç–µ:**
- –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω aiogram –∏–∑–Ω—É—Ç—Ä–∏
- –ü–æ—á–µ–º—É –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ 3.x —Å—Ç–∞–ª–∞ —Ç–∞–∫–æ–π –º–æ—â–Ω–æ–π
- –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤—ã–≤–∞—Ç—å –∫–æ–¥ –≤ –±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö
- –ß—Ç–æ —Ç–∞–∫–æ–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –∏ –ø–æ—á–µ–º—É –æ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞
- –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Dependency Injection –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥–∏–±–∫–∏—Ö —Å–∏—Å—Ç–µ–º
- –ö–∞–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–æ—Ç–æ–≤

–≠—Ç–∞ –≥–ª–∞–≤–∞ –Ω–∞–ø–∏—Å–∞–Ω–∞ –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ö–æ—á–µ—Ç –Ω–µ –ø—Ä–æ—Å—Ç–æ "—Å–¥–µ–ª–∞—Ç—å —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ –±–æ—Ç–∞", –∞ –ø–æ–Ω—è—Ç—å, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –Ω–∞ –≥–ª—É–±–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ. –ú—ã –±—É–¥–µ–º –¥–≤–∏–≥–∞—Ç—å—Å—è –æ—Ç –ø—Ä–æ—Å—Ç–æ–≥–æ –∫ —Å–ª–æ–∂–Ω–æ–º—É, —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –ø—Ä–∏–º–µ—Ä–æ–≤, –∞–Ω–∞–ª–æ–≥–∏–π –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.

**–í–∞–∂–Ω–æ:** –ú–∞—Ç–µ—Ä–∏–∞–ª —ç—Ç–æ–π –≥–ª–∞–≤—ã —è–≤–ª—è–µ—Ç—Å—è —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–æ–º –¥–ª—è –≤—Å–µ—Ö –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —Ç–µ–º. –ù–µ —Ç–æ—Ä–æ–ø–∏—Ç–µ—Å—å, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –ø–æ–Ω–∏–º–∞–µ—Ç–µ –∫–∞–∂–¥—É—é –∫–æ–Ω—Ü–µ–ø—Ü–∏—é –ø–µ—Ä–µ–¥ —Ç–µ–º, –∫–∞–∫ –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ.

---

## üìú –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è aiogram

### –û—Ç –≤–µ—Ä—Å–∏–∏ 1.x –∫ 3.x

#### Aiogram 1.x (2015-2019)
- –ü–µ—Ä–≤–∞—è –≤–µ—Ä—Å–∏—è, —Å–æ–∑–¥–∞–Ω–Ω–∞—è –∫–∞–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ pyTelegramBotAPI
- –ü—Ä–æ—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –±–∞–∑–æ–≤–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Bot API
- –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã —Å–º–µ—à–∏–≤–∞–ª–∏—Å—å
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

#### Aiogram 2.x (2019-2023)
- –ü–æ–ª–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥, —É–ª—É—á—à–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- –í–≤–µ–¥–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ "–º–∞–≥–∏—á–µ—Å–∫–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤"
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ middleware
- –°–º–µ—à–∞–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ-–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å

#### Aiogram 3.x (2023-–Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è)
- –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–æ—É—Ç–µ—Ä–æ–≤
- –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è
- –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Dependency Injection
- –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ 3.x

1. **–ü–æ–ª–Ω–∞—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å**: –í—Å–µ –º–µ—Ç–æ–¥—ã —Ç–µ–ø–µ—Ä—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ
2. **–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–æ—É—Ç–µ—Ä–æ–≤**: –ë–æ–ª–µ–µ –≥–∏–±–∫–∞—è –∏ –º–æ—â–Ω–∞—è
3. **–£–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è**: –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ type hints
4. **Dependency Injection**: –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
5. **–ù–æ–≤—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã**: –ë–æ–ª–µ–µ –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–µ –∏ –≥–∏–±–∫–∏–µ
6. **–£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ aiogram 3.x

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

Aiogram 3.x –ø–æ—Å—Ç—Ä–æ–µ–Ω –ø–æ –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ, –≥–¥–µ –∫–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–≤–æ—é –æ–±–ª–∞—Å—Ç—å:

```mermaid
graph TB
    A[Telegram API] --> B[Bot]
    B --> C[Dispatcher]
    C --> D[Router]
    D --> E[Handler]
    C --> F[Middleware]
    C --> G[Filter]
    H[Storage] --> C
    I[Services] --> E
```

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- **Bot** - –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫ Telegram API
- **Dispatcher** - —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –¥–∏—Å–ø–µ—Ç—á–µ—Ä, —É–ø—Ä–∞–≤–ª—è—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- **Router** - –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç —Ö–µ–Ω–¥–ª–µ—Ä—ã –≤ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã
- **Handler** - —Ñ—É–Ω–∫—Ü–∏–∏, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–∏–ø—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- **Middleware** - –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **Filter** - —É—Å–ª–æ–≤–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ö–µ–Ω–¥–ª–µ—Ä–∞
- **Storage** - —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏–π (FSM)
- **Services** - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

–î–∞–≤–∞–π—Ç–µ –ø—Ä–æ—Å–ª–µ–¥–∏–º –ø—É—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ –æ—Ç–≤–µ—Ç–∞:

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä
2. **Bot**: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∏ –ø–∞—Ä—Å–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –æ–±—ä–µ–∫—Ç—ã Python
3. **Dispatcher**: –ü–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É
4. **Middleware**: –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–≥—É—Ç –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –ø—Ä–µ—Ä–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
5. **Filter**: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥ —É—Å–ª–æ–≤–∏—è —Ö–µ–Ω–¥–ª–µ—Ä–∞
6. **Router**: –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–æ–º—É —Ä–æ—É—Ç–µ—Ä—É –ø–µ—Ä–µ–¥–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
7. **Handler**: –í—ã–ø–æ–ª–Ω—è–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
8. **Services**: –•–µ–Ω–¥–ª–µ—Ä –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
9. **Storage**: –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ
10. **Bot**: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ Telegram API

```python
# –ü—Ä–∏–º–µ—Ä –ø–æ—Ç–æ–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
@dp.message(F.text == "–ø—Ä–∏–≤–µ—Ç")  # 1. Filter –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ª–æ–≤–∏–µ
async def hello_handler(message: Message):  # 2. Handler –ø–æ–ª—É—á–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    # 3. Handler –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ—Ä–≤–∏—Å
    user = await user_service.get_user(message.from_user.id)
    # 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ Bot
    await message.answer(f"–ü—Ä–∏–≤–µ—Ç, {user.name}!")
```

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å aiogram 2.x

| –ê—Å–ø–µ–∫—Ç | aiogram 2.x | aiogram 3.x |
|--------|-------------|-------------|
| –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å | –ß–∞—Å—Ç–∏—á–Ω–∞—è | –ü–æ–ª–Ω–∞—è |
| –†–æ—É—Ç–µ—Ä—ã | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å—é |
| –¢–∏–ø–∏–∑–∞—Ü–∏—è | –ß–∞—Å—Ç–∏—á–Ω–∞—è | –ü–æ–ª–Ω–∞—è |
| DI | –ù–µ—Ç | –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ |
| –§–∏–ª—å—Ç—Ä—ã | –ú–∞–≥–∏—á–µ—Å–∫–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã | –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π F |
| Middleware | –ë–∞–∑–æ–≤–∞—è | –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | –•–æ—Ä–æ—à–∞—è | –û—Ç–ª–∏—á–Ω–∞—è |

---

## üîÑ Dispatcher - —Å–µ—Ä–¥—Ü–µ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞

### –ß—Ç–æ —Ç–∞–∫–æ–µ Dispatcher?

**Dispatcher** ‚Äî —ç—Ç–æ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –Ω–µ—Ä–≤–Ω—ã–π —Å–∏—Å—Ç–µ–º–∞ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞. –ï—Å–ª–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –±–æ—Ç–∞ –∫–∞–∫ –æ—Ä–≥–∞–Ω–∏–∑–º, —Ç–æ:
- **Bot** ‚Äî —ç—Ç–æ –æ—Ä–≥–∞–Ω—ã —á—É–≤—Å—Ç–≤ (–≥–ª–∞–∑–∞, —É—à–∏)
- **Handler** ‚Äî —ç—Ç–æ —Ä–µ—Ñ–ª–µ–∫—Å—ã –∏ —Ä–µ–∞–∫—Ü–∏–∏
- **Dispatcher** ‚Äî —ç—Ç–æ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –Ω–µ—Ä–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞, –∫–æ—Ç–æ—Ä–∞—è —Å–≤—è–∑—ã–≤–∞–µ—Ç –≤—Å—ë –≤–º–µ—Å—Ç–µ

**–û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ Dispatcher:**
1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π** –æ—Ç Telegram API
2. **–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è** –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∫ –Ω—É–∂–Ω—ã–º —Ö–µ–Ω–¥–ª–µ—Ä–∞–º
3. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º** –∫–∞–∂–¥–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
4. **–ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è** –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ (middleware, —Ñ–∏–ª—å—Ç—Ä—ã, —Ö–µ–Ω–¥–ª–µ—Ä—ã)
5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π

### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

–î–∞–≤–∞–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ —Ä–∞–∑–±–µ—Ä–µ–º, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å –∫–∞–∂–¥—ã–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º:

```mermaid
sequenceDiagram
    participant T as Telegram
    participant B as Bot
    participant D as Dispatcher
    participant M as Middleware
    participant F as Filter
    participant H as Handler
    participant S as Storage

    T->>B: Update (message/callback/etc)
    B->>D: Parsed update
    D->>M: Pre-process
    M->>D: Modified data
    D->>F: Check filters
    alt Filters passed
        F->>D: True
        D->>H: Execute handler
        H->>S: Save state (if needed)
        H->>B: Send response
        B->>T: Response
    else Filters failed
        F->>D: False
        D->>D: Try next handler
    end
```

**–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞:**

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç JSON —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
2. **–ü–∞—Ä—Å–∏–Ω–≥**: Bot –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç JSON –≤ –æ–±—ä–µ–∫—Ç—ã Python (Message, CallbackQuery –∏ —Ç.–¥.)
3. **–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**: Middleware –º–æ–≥—É—Ç:
   - –î–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
   - –ò–∑–º–µ–Ω–∏—Ç—å –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
4. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è**: –§–∏–ª—å—Ç—Ä—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç —É—Å–ª–æ–≤–∏—è:
   - –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è
   - –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —É—Å–ª–æ–≤–∏—è
5. **–í—ã–±–æ—Ä —Ö–µ–Ω–¥–ª–µ—Ä–∞**: Dispatcher –Ω–∞—Ö–æ–¥–∏—Ç –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ö–µ–Ω–¥–ª–µ—Ä
6. **–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ**: –•–µ–Ω–¥–ª–µ—Ä –≤—ã–ø–æ–ª–Ω—è–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
7. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è**: –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ Storage
8. **–û—Ç–≤–µ—Ç**: Bot –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ Telegram API

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã Dispatcher

#### 1. `include_router(router)`
–ü–æ–¥–∫–ª—é—á–∞–µ—Ç —Ä–æ—É—Ç–µ—Ä –∫ –¥–∏—Å–ø–µ—Ç—á–µ—Ä—É. –≠—Ç–æ –∫–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –æ—Ç–¥–µ–ª –≤ –∫–æ–º–ø–∞–Ω–∏—é.

```python
from aiogram import Router

# –°–æ–∑–¥–∞–µ–º —Ä–æ—É—Ç–µ—Ä—ã
user_router = Router()
admin_router = Router()
payment_router = Router()

# –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫ –¥–∏—Å–ø–µ—Ç—á–µ—Ä—É
dp.include_router(user_router)
dp.include_router(admin_router)
dp.include_router(payment_router)
```

**–í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
- –ü–æ—Ä—è–¥–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤–∞–∂–µ–Ω: —Ö–µ–Ω–¥–ª–µ—Ä—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –≤ –ø–æ—Ä—è–¥–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ä–æ—É—Ç–µ—Ä–æ–≤
- –ú–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∞—Ç—å —Ä–æ—É—Ç–µ—Ä—ã –≤–Ω—É—Ç—Ä–∏ –¥—Ä—É–≥–∏—Ö —Ä–æ—É—Ç–µ—Ä–æ–≤ (–≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å)
- –û–¥–∏–Ω —Ä–æ—É—Ç–µ—Ä –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑

#### 2. `start_polling(bot)`
–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ long polling.

```python
async def main():
    # –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—É—Å–∫
    await dp.start_polling(bot)
    
    # –° –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
    await dp.start_polling(
        bot,
        skip_updates=True,  # –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        timeout=30,         # –¢–∞–π–º–∞—É—Ç –æ–ø—Ä–æ—Å–∞
        allowed_updates=["message", "callback_query"]  # –¢–∏–ø—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    )
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `skip_updates` - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
- `timeout` - —Ç–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- `allowed_updates` - —Å–ø–∏—Å–æ–∫ —Ç–∏–ø–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è

#### 3. `feed_update(update)`
–ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–¥–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –¥–∏—Å–ø–µ—Ç—á–µ—Ä. –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

```python
from aiogram.types import Update, Message

# –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
test_message = Message(
    message_id=1,
    date=1234567890,
    chat=types.Chat(id=123, type="private"),
    from_user=types.User(id=456, is_bot=False, first_name="Test"),
    text="test message"
)

# –°–æ–∑–¥–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
update = Update(update_id=1, message=test_message)

# –ü–µ—Ä–µ–¥–∞–µ–º –≤ –¥–∏—Å–ø–µ—Ç—á–µ—Ä
await dp.feed_update(update)
```

#### 4. `workflow_data`, `context`, `storage`
–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º.

```python
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤–æ—Ä–∫—Ñ–ª–æ—É
dp.workflow_data["db"] = database_connection

# –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ö–µ–Ω–¥–ª–µ—Ä–µ
@dp.message(Command("data"))
async def cmd_data(message: Message, **kwargs):
    db = kwargs.get("db")
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î
```

### –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

Dispatcher –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–≤–æ–µ–π —Ä–∞–±–æ—Ç—ã:

#### 1. Observer (–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å)
–ù–∞–±–ª—é–¥–∞—Ç–µ–ª–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:
- `message_observer` - –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
- `callback_query_observer` - –¥–ª—è callback-–∑–∞–ø—Ä–æ—Å–æ–≤
- `inline_query_observer` - –¥–ª—è inline-–∑–∞–ø—Ä–æ—Å–æ–≤
- –∏ —Ç.–¥.

```python
# –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è–º
message_observer = dp.message_observer
callback_observer = dp.callback_query_observer
```

#### 2. Handler Registry (–†–µ–µ—Å—Ç—Ä —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤)
–•—Ä–∞–Ω–∏—Ç –≤—Å–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã —Å –∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞–º–∏.

```python
# –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤
for handler in dp.handlers.handlers:
    print(f"Handler: {handler.callback}, filters: {handler.filters}")
```

#### 3. Middleware Manager
–£–ø—Ä–∞–≤–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º middleware –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.

```python
# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è middleware
dp.update.outer_middleware(AuthMiddleware())
dp.update.middleware(LoggingMiddleware())
```

### –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

#### 1. –ö–∞—Å—Ç–æ–º–Ω—ã–µ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–∏
–ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤–æ–∏ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π:

```python
from aiogram.dispatcher.event.handler import HandlerObject
from aiogram.dispatcher.event.bases import UNHANDLED

class CustomObserver:
    def __init__(self):
        self.handlers = []
    
    def register(self, handler, filters=None):
        self.handlers.append(HandlerObject(handler, filters))
    
    async def trigger(self, event, **kwargs):
        for handler in self.handlers:
            result = await handler.call(event, **kwargs)
            if result is not UNHANDLED:
                return result

# –°–æ–∑–¥–∞–µ–º –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å
custom_observer = CustomObserver()
dp.observers["custom"] = custom_observer
```

#### 2. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤
–ú–æ–∂–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ö–µ–Ω–¥–ª–µ—Ä—ã –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

```python
def create_dynamic_handler(command):
    async def handler(message: Message):
        await message.answer(f"–í—ã–∑–≤–∞–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∫–æ–º–∞–Ω–¥–∞: {command}")
    return handler

# –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ö–µ–Ω–¥–ª–µ—Ä
dynamic_handler = create_dynamic_handler("test")
dp.message.register(dynamic_handler, Command("test"))
```

#### 3. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤
–•–µ–Ω–¥–ª–µ—Ä—ã –º–æ–∂–Ω–æ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏:

```python
from aiogram.dispatcher.flags import get_flag

@dp.message(Command("admin"), flags={"admin_only": True})
async def admin_command(message: Message):
    await message.answer("–ê–¥–º–∏–Ω –∫–æ–º–∞–Ω–¥–∞")

@dp.message(Command("superuser"), flags={"admin_only": True})
async def superuser_command(message: Message):
    await message.answer("–°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–æ–º–∞–Ω–¥–∞")

# Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–ª–∞–≥–æ–≤
@dp.update.outer_middleware()
async def admin_check(handler, event, data):
    if get_flag(data, "admin_only"):
        if not await is_admin(event.from_user.id):
            return await event.answer("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
    return await handler(event, data)
```

---

## ü§ñ Bot - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫ Telegram API

### –ß—Ç–æ —Ç–∞–∫–æ–µ Bot?

**Bot** ‚Äî —ç—Ç–æ –≤–∞—à –ª–∏—á–Ω—ã–π –¥–∏–ø–ª–æ–º–∞—Ç, –∫–æ—Ç–æ—Ä—ã–π –≥–æ–≤–æ—Ä–∏—Ç –Ω–∞ —è–∑—ã–∫–µ Python –∏ –ø–æ–Ω–∏–º–∞–µ—Ç —è–∑—ã–∫ Telegram API. –ö–æ–≥–¥–∞ –≤—ã —Ö–æ—Ç–∏—Ç–µ —á—Ç–æ-—Ç–æ —Å–¥–µ–ª–∞—Ç—å –≤ Telegram, –≤—ã –æ–±—Ä–∞—â–∞–µ—Ç–µ—Å—å –∫ –æ–±—ä–µ–∫—Ç—É Bot, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –≤–∞—à–∏ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ —è–∑—ã–∫, –ø–æ–Ω—è—Ç–Ω—ã–π Telegram.

**–ê–Ω–∞–ª–æ–≥–∏—è:** –ï—Å–ª–∏ Telegram ‚Äî —ç—Ç–æ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞, —Ç–æ:
- **Bot** ‚Äî —ç—Ç–æ –≤–∞—à –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫
- **Telegram API** ‚Äî —ç—Ç–æ —è–∑—ã–∫ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω—ã
- **–ú–µ—Ç–æ–¥—ã Bot** ‚Äî —ç—Ç–æ —Ñ—Ä–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –ø—Ä–æ—Å–∏—Ç–µ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã Bot

#### 1. –ú–µ—Ç–æ–¥—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

```python
# –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
await bot.send_message(
    chat_id=123456,
    text="–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç aiogram 3.x",
    parse_mode="HTML",
    disable_web_page_preview=True,
    reply_markup=types.InlineKeyboardMarkup(
        inline_keyboard=[
            [types.InlineKeyboardButton(text="–ù–∞–∂–º–∏ –º–µ–Ω—è", callback_data="test")]
        ]
    )
)

# –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ —Å –ø–æ–¥–ø–∏—Å—å—é
await bot.send_photo(
    chat_id=123456,
    photo="https://example.com/image.jpg",
    caption="–ö—Ä–∞—Å–∏–≤–æ–µ —Ñ–æ—Ç–æ",
    caption_entities=[
        types.MessageEntity(type="bold", offset=0, length=7)
    ]
)

# –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
await bot.send_document(
    chat_id=123456,
    document=types.FSInputFile("document.pdf"),
    caption="–í–∞–∂–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç",
    thumbnail=types.FSInputFile("thumbnail.jpg")
)

# –û—Ç–ø—Ä–∞–≤–∫–∞ –∞—É–¥–∏–æ
await bot.send_audio(
    chat_id=123456,
    audio=types.FSInputFile("audio.mp3"),
    title="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞",
    performer="–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å",
    duration=180,
    thumbnail=types.FSInputFile("cover.jpg")
)

# –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–∏–¥–µ–æ
await bot.send_video(
    chat_id=123456,
    video=types.FSInputFile("video.mp4"),
    caption="–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –≤–∏–¥–µ–æ",
    width=1280,
    height=720,
    duration=120,
    thumbnail=types.FSInputFile("preview.jpg"),
    supports_streaming=True
)

# –û—Ç–ø—Ä–∞–≤–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
await bot.send_voice(
    chat_id=123456,
    voice=types.FSInputFile("voice.ogg"),
    duration=30
)

# –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∏–∫–µ—Ä–∞
await bot.send_sticker(
    chat_id=123456,
    sticker="ABC123DEF456"
)

# –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
await bot.send_animation(
    chat_id=123456,
    animation=types.FSInputFile("animation.gif"),
    duration=5,
    width=400,
    height=400
)

# –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞
await bot.send_contact(
    chat_id=123456,
    phone_number="+1234567890",
    first_name="John",
    last_name="Doe",
    vcard="VCARD_DATA"
)

# –û—Ç–ø—Ä–∞–≤–∫–∞ –ª–æ–∫–∞—Ü–∏–∏
await bot.send_location(
    chat_id=123456,
    latitude=55.7558,
    longitude=37.6173,
    horizontal_accuracy=50.0,
    live_period=3600,
    heading=90,
    proximity_alert_radius=100
)

# –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–µ–Ω—é
await bot.send_venue(
    chat_id=123456,
    latitude=55.7558,
    longitude=37.6173,
    title="–ö—Ä–∞—Å–Ω–∞—è –ø–ª–æ—â–∞–¥—å",
    address="–ú–æ—Å–∫–≤–∞, –†–æ—Å—Å–∏—è",
    foursquare_id="4bf58dd8d48988d110941735"
)

# –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–ø—Ä–æ—Å–∞
await bot.send_poll(
    chat_id=123456,
    question="–í–∞–º –Ω—Ä–∞–≤–∏—Ç—Å—è aiogram?",
    options=["–î–∞", "–ù–µ—Ç", "–ó–∞—Ç—Ä—É–¥–Ω—è—é—Å—å –æ—Ç–≤–µ—Ç–∏—Ç—å"],
    is_anonymous=False,
    type="regular",
    allows_multiple_answers=False,
    correct_option_id=0,
    explanation="–≠—Ç–æ –æ–ø—Ä–æ—Å –æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–µ aiogram",
    explanation_parse_mode="HTML",
    open_period=3600
)

# –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–π—Å–∞
await bot.send_dice(
    chat_id=123456,
    emoji="üé≤"
)
```

#### 2. –ú–µ—Ç–æ–¥—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

```python
# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
await bot.edit_message_text(
    chat_id=123456,
    message_id=789,
    text="–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç",
    parse_mode="HTML",
    reply_markup=types.InlineKeyboardMarkup(
        inline_keyboard=[
            [types.InlineKeyboardButton(text="–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞", callback_data="updated")]
        ]
    )
)

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏ –º–µ–¥–∏–∞
await bot.edit_message_caption(
    chat_id=123456,
    message_id=789,
    caption="–ù–æ–≤–∞—è –ø–æ–¥–ø–∏—Å—å",
    parse_mode="HTML",
    reply_markup=types.InlineKeyboardMarkup(...)
)

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ media
await bot.edit_message_media(
    chat_id=123456,
    message_id=789,
    media=types.InputMediaPhoto(
        media="https://example.com/new_image.jpg",
        caption="–ù–æ–≤–æ–µ —Ñ–æ—Ç–æ"
    ),
    reply_markup=types.InlineKeyboardMarkup(...)
)

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
await bot.edit_message_reply_markup(
    chat_id=123456,
    message_id=789,
    reply_markup=types.InlineKeyboardMarkup(...)
)
```

#### 3. –ú–µ—Ç–æ–¥—ã —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

```python
# –£–¥–∞–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
await bot.delete_message(
    chat_id=123456,
    message_id=789
)

# –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
await bot.delete_messages(
    chat_id=123456,
    message_ids=[789, 790, 791]
)
```

#### 4. –ú–µ—Ç–æ–¥—ã –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

```python
# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ
me = await bot.get_me()
print(f"Bot ID: {me.id}")
print(f"Bot name: {me.first_name}")
print(f"Username: {me.username}")
print(f"Can join groups: {me.can_join_groups}")
print(f"Can read all group messages: {me.can_read_all_group_messages}")
print(f"Supports inline queries: {me.supports_inline_queries}")

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ
chat = await bot.get_chat(chat_id=123456)
print(f"Chat type: {chat.type}")
print(f"Chat title: {chat.title}")
print(f"Chat description: {chat.description}")
print(f"Chat members count: {await bot.get_chat_member_count(chat_id=123456)}")

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
user = await bot.get_user(user_id=123456789)
print(f"User ID: {user.id}")
print(f"First name: {user.first_name}")
print(f"Last name: {user.last_name}")
print(f"Username: {user.username}")
print(f"Language code: {user.language_code}")
print(f"Is bot: {user.is_bot}")
print(f"Is premium: {user.is_premium}")

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–ª–µ–Ω–µ —á–∞—Ç–∞
chat_member = await bot.get_chat_member(
    chat_id=123456,
    user_id=789012
)
print(f"Status: {chat_member.status}")
print(f"User: {chat_member.user}")
print(f"Until date: {chat_member.until_date}")
print(f"Can be edited: {chat_member.can_be_edited}")
print(f"Can post messages: {chat_member.can_post_messages}")
print(f"Can edit messages: {chat_member.can_edit_messages}")
print(f"Can delete messages: {chat_member.can_delete_messages}")
print(f"Can restrict members: {chat_member.can_restrict_members}")
print(f"Can promote members: {chat_member.can_promote_members}")
print(f"Can change info: {chat_member.can_change_info}")
print(f"Can invite users: {chat_member.can_invite_users}")
print(f"Can pin messages: {chat_member.can_pin_messages}")
print(f"Can manage topics: {chat_member.can_manage_topics}")
print(f"Can manage video chats: {chat_member.can_manage_video_chats}")
print(f"Is anonymous: {chat_member.is_anonymous}")

# –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã —á–∞—Ç–∞
admins = await bot.get_chat_administrators(chat_id=123456)
for admin in admins:
    print(f"Admin: {admin.user.first_name}")

# –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞ (–¥–ª—è —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø)
async for member in bot.get_chat_administrators(chat_id=123456):
    print(f"Member: {member.user.first_name}")

# –°—Ç–∏–∫–µ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
stickers = await bot.get_user_profile_photos(
    user_id=123456789,
    offset=0,
    limit=100
)
print(f"Total photos: {stickers.total_count}")

# –§–∞–π–ª
file_info = await bot.get_file(file_id="ABC123DEF456")
print(f"File path: {file_info.file_path}")
print(f"File size: {file_info.file_size}")
print(f"File unique ID: {file_info.file_unique_id}")

# –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
from aiogram import types
file = await bot.download_file(file_info.file_path)
with open("downloaded_file.jpg", "wb") as f:
    f.write(file)
```

#### 5. –ú–µ—Ç–æ–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞–º–∏

```python
# –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
invite_link = await bot.create_chat_invite_link(
    chat_id=123456,
    name="–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥–ª—è –¥—Ä—É–∑–µ–π",
    expire_date=int(time.time()) + 3600,  # –ß–µ—Ä–µ–∑ —á–∞—Å
    member_limit=10,
    creates_join_request=True
)
print(f"Invite link: {invite_link.invite_link}")
print(f"Creator: {invite_link.creator}")
print(f"Creates join request: {invite_link.creates_join_request}")
print(f"Is primary: {invite_link.is_primary}")
print(f"Is revoked: {invite_link.is_revoked}")

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
edited_link = await bot.edit_chat_invite_link(
    chat_id=123456,
    invite_link=invite_link.invite_link,
    name="–û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ",
    expire_date=int(time.time()) + 7200
)

# –û—Ç–∑—ã–≤ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
await bot.revoke_chat_invite_link(
    chat_id=123456,
    invite_link=invite_link.invite_link
)

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤
await bot.set_chat_permissions(
    chat_id=123456,
    permissions=types.ChatPermissions(
        can_send_messages=True,
        can_send_media_messages=True,
        can_send_polls=True,
        can_send_other_messages=True,
        can_add_web_page_previews=True,
        can_change_info=False,
        can_invite_users=True,
        can_pin_messages=False
    )
)

# –≠–∫—Å–ø–æ—Ä—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
exported_link = await bot.export_chat_invite_link(chat_id=123456)
print(f"Exported link: {exported_link}")

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–æ—Ç–æ —á–∞—Ç–∞
await bot.set_chat_photo(
    chat_id=123456,
    photo=types.FSInputFile("chat_photo.jpg")
)

# –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ —á–∞—Ç–∞
await bot.delete_chat_photo(chat_id=123456)

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏—è —á–∞—Ç–∞
await bot.set_chat_title(
    chat_id=123456,
    title="–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞"
)

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è —á–∞—Ç–∞
await bot.set_chat_description(
    chat_id=123456,
    description="–û–ø–∏—Å–∞–Ω–∏–µ —á–∞—Ç–∞"
)

# –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
await bot.pin_chat_message(
    chat_id=123456,
    message_id=789,
    disable_notification=False
)

# –û—Ç–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
await bot.unpin_chat_message(
    chat_id=123456,
    message_id=789
)

# –û—Ç–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
await bot.unpin_all_chat_messages(chat_id=123456)

# –ö–∏–∫–Ω—É—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
await bot.ban_chat_member(
    chat_id=123456,
    user_id=789012,
    until_date=int(time.time()) + 3600,  # –ù–∞ —á–∞—Å
    revoke_messages=True
)

# –†–∞–∑–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
await bot.unban_chat_member(
    chat_id=123456,
    user_id=789012,
    only_if_banned=True
)

# –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
await bot.restrict_chat_member(
    chat_id=123456,
    user_id=789012,
    permissions=types.ChatPermissions(
        can_send_messages=False,
        can_send_media_messages=False,
        can_send_polls=False,
        can_send_other_messages=False,
        can_add_web_page_previews=False
    ),
    until_date=int(time.time()) + 3600,
    use_independent_chat_permissions=True
)

# –ü–æ–≤—ã—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
await bot.promote_chat_member(
    chat_id=123456,
    user_id=789012,
    can_change_info=True,
    can_post_messages=True,
    can_edit_messages=True,
    can_delete_messages=True,
    can_invite_users=True,
    can_restrict_members=True,
    can_pin_messages=True,
    can_manage_topics=True,
    can_manage_video_chats=True,
    can_promote_members=False,
    is_anonymous=False
)

# –ü–æ–Ω–∏–∑–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
await bot.promote_chat_member(
    chat_id=123456,
    user_id=789012,
    can_change_info=False,
    can_post_messages=False,
    can_edit_messages=False,
    can_delete_messages=False,
    can_invite_users=False,
    can_restrict_members=False,
    can_pin_messages=False,
    can_manage_topics=False,
    can_manage_video_chats=False,
    can_promote_members=False,
    is_anonymous=False
)

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
await bot.set_chat_administrator_custom_title(
    chat_id=123456,
    user_id=789012,
    custom_title="–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä"
)

# –°–æ–∑–¥–∞—Ç—å —Ç–µ–º—É –≤ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–µ
forum_topic = await bot.create_forum_topic(
    chat_id=123456,
    name="–ù–æ–≤–∞—è —Ç–µ–º–∞",
    icon_color=0x6FB9F0,
    icon_custom_emoji_id="ABC123"
)
print(f"Topic ID: {forum_topic.message_id}")

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–º—É
await bot.edit_forum_topic(
    chat_id=123456,
    message_id=forum_topic.message_id,
    name="–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ç–µ–º–∞",
    icon_custom_emoji_id="DEF456"
)

# –ó–∞–∫—Ä—ã—Ç—å —Ç–µ–º—É
await bot.close_forum_topic(
    chat_id=123456,
    message_id=forum_topic.message_id
)

# –û—Ç–∫—Ä—ã—Ç—å —Ç–µ–º—É
await bot.reopen_forum_topic(
    chat_id=123456,
    message_id=forum_topic.message_id
)

# –£–¥–∞–ª–∏—Ç—å —Ç–µ–º—É
await bot.delete_forum_topic(
    chat_id=123456,
    message_id=forum_topic.message_id
)

# –ó–∞–∫—Ä–µ–ø–∏—Ç—å —Ç–µ–º—É
await bot.unpin_all_forum_topic_messages(
    chat_id=123456,
    message_id=forum_topic.message_id
)

# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—â–∏–µ –ø—Ä–∞–≤–∞ —á–∞—Ç–∞
await bot.set_my_default_administrator_rights(
    rights=types.ChatAdministratorRights(
        is_anonymous=False,
        can_manage_chat=True,
        can_change_info=True,
        can_post_messages=True,
        can_edit_messages=True,
        can_delete_messages=True,
        can_invite_users=True,
        can_restrict_members=True,
        can_pin_messages=True,
        can_manage_topics=True,
        can_promote_members=True,
        can_manage_video_chats=True
    )
)
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Bot

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Bot –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –µ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è:

```python
from aiogram import Bot
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode

# –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
bot = Bot(token="YOUR_TOKEN")

# –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
bot = Bot(
    token="YOUR_TOKEN",
    default=DefaultBotProperties(
        parse_mode=ParseMode.HTML,  # –†–µ–∂–∏–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        link_preview_is_disabled=True,  # –û—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–µ–≤—å—é —Å—Å—ã–ª–æ–∫
        protect_content=True,  # –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ—Å—ã–ª–∫–∏
        allow_sending_without_reply=True  # –†–∞–∑—Ä–µ—à–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –±–µ–∑ –æ—Ç–≤–µ—Ç–∞
    ),
    session=session,  # –ö–∞—Å—Ç–æ–º–Ω–∞—è —Å–µ—Å—Å–∏—è aiohttp
    timeout=10,  # –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–æ–≤
    api_url="https://api.telegram.org"  # –ö–∞—Å—Ç–æ–º–Ω—ã–π URL API
)
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã DefaultBotProperties:**
- `parse_mode` - —Ä–µ–∂–∏–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (HTML/Markdown)
- `link_preview_is_disabled` - –æ—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–µ–≤—å—é —Å—Å—ã–ª–æ–∫
- `protect_content` - –∑–∞—â–∏—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –æ—Ç –ø–µ—Ä–µ—Å—ã–ª–∫–∏
- `allow_sending_without_reply` - —Ä–∞–∑—Ä–µ—à–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –±–µ–∑ –æ—Ç–≤–µ—Ç–∞
- `disable_notification` - –æ—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

### –†–∞–±–æ—Ç–∞ —Å —Å–µ—Å—Å–∏—è–º–∏

Bot –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ—Å—Å–∏–∏ aiohttp –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤. –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—É—é —Å–µ—Å—Å–∏—é:

```python
import aiohttp
from aiogram import Bot

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å–µ—Å—Å–∏–∏
session = aiohttp.ClientSession(
    timeout=aiohttp.ClientTimeout(total=30),
    connector=aiohttp.TCPConnector(limit=100),
    headers={"User-Agent": "MyBot/1.0"}
)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
bot = Bot(token="YOUR_TOKEN", session=session)

# –í–∞–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å —Å–µ—Å—Å–∏—é –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
async def close_bot():
    await session.close()
    await bot.session.close()
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

Bot –º–æ–∂–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å API:

```python
from aiogram.exceptions import TelegramAPIError, TelegramBadRequest, TelegramForbiddenError

try:
    await bot.send_message(chat_id=123456, text="–¢–µ—Å—Ç")
except TelegramBadRequest as e:
    print(f"Bad request: {e}")
except TelegramForbiddenError as e:
    print(f"Forbidden: {e}")
except TelegramAPIError as e:
    print(f"API error: {e}")
```

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∏–ø—ã –∏—Å–∫–ª—é—á–µ–Ω–∏–π:**
- `TelegramBadRequest` - –Ω–µ–≤–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å
- `TelegramUnauthorizedError` - –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø
- `TelegramForbiddenError` - –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω
- `TelegramNotFound` - —Ä–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω
- `TelegramConflictError` - –∫–æ–Ω—Ñ–ª–∏–∫—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω)
- `TelegramRetryAfter` - —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤
- `TelegramAPIError` - –æ–±—â–∞—è –æ—à–∏–±–∫–∞ API

---

## üó∫Ô∏è Router - –æ—Ä–≥–∞–Ω–∏–∑—É–µ–º –∫–æ–¥ –ª–æ–≥–∏—á–Ω–æ

### –ß—Ç–æ —Ç–∞–∫–æ–µ Router?

**Router** ‚Äî —ç—Ç–æ –∫–∞–∫ —Ä–∞–∑–¥–µ–ª—ã –≤ –±–æ–ª—å—à–æ–π —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏. –í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –ø–∏—Å–∞—Ç—å –≤—Å–µ —Å—Ç–∞—Ç—å–∏ –≤ –æ–¥–Ω–æ–º —Ç–æ–º–µ, –º—ã —Ä–∞–∑–¥–µ–ª—è–µ–º –∏—Ö –ø–æ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Ä–∞–∑–¥–µ–ª–∞–º:
- –¢–æ–º "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏" - –≤—Å–µ, —á—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- –¢–æ–º "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ" - —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
- –¢–æ–º "–ü–ª–∞—Ç–µ–∂–∏" - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- –ò —Ç–∞–∫ –¥–∞–ª–µ–µ

**–ê–Ω–∞–ª–æ–≥–∏—è –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏:**
–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ –±–æ–ª—å—à–æ–π —Ç–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä:
- **Dispatcher** - —ç—Ç–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è —Ü–µ–Ω—Ç—Ä–∞
- **Router** - —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω—ã (–æ–¥–µ–∂–¥–∞, —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞, –ø—Ä–æ–¥—É–∫—Ç—ã)
- **Handler** - —ç—Ç–æ –ø—Ä–æ–¥–∞–≤—Ü—ã –≤ –∫–∞–∂–¥–æ–º –º–∞–≥–∞–∑–∏–Ω–µ
- **–ü–æ–∫—É–ø–∞—Ç–µ–ª—å** –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—é (Dispatcher), –µ–≥–æ –Ω–∞–ø—Ä–∞–≤–ª—è—é—Ç –≤ –Ω—É–∂–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω (Router), –≥–¥–µ –µ–º—É –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–æ–¥–∞–≤–µ—Ü (Handler)

### –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã

#### 1. –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
–†–æ—É—Ç–µ—Ä—ã –º–æ–≥—É—Ç –±—ã—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏, —Å–æ–∑–¥–∞–≤–∞—è –¥—Ä–µ–≤–æ–≤–∏–¥–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É:

```
Main Router
‚îú‚îÄ‚îÄ User Router
‚îÇ   ‚îú‚îÄ‚îÄ Profile Handler
‚îÇ   ‚îî‚îÄ‚îÄ Settings Handler
‚îú‚îÄ‚îÄ Admin Router
‚îÇ   ‚îú‚îÄ‚îÄ Stats Handler
‚îÇ   ‚îî‚îÄ‚îÄ Manage Handler
‚îî‚îÄ‚îÄ Payment Router
    ‚îú‚îÄ‚îÄ Create Payment Handler
    ‚îî‚îÄ‚îÄ Check Payment Handler
```

#### 2. –ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ middleware
Middleware, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º —Ä–æ—É—Ç–µ—Ä–µ, –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ –≤—Å–µ–º –¥–æ—á–µ—Ä–Ω–∏–º:

```python
main_router = Router()
user_router = Router()

# Middleware –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è –∫–æ –≤—Å–µ–º —Ö–µ–Ω–¥–ª–µ—Ä–∞–º user_router
@main_router.middleware()
async def main_middleware(handler, event, data):
    print("Main middleware")
    return await handler(event, data)

main_router.include_router(user_router)
```

#### 3. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
–•–µ–Ω–¥–ª–µ—Ä—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –≤ –ø–æ—Ä—è–¥–∫–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–æ—É—Ç–µ—Ä–æ–≤:

```python
# –≠—Ç–æ—Ç —Ö–µ–Ω–¥–ª–µ—Ä –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å—Å—è –ø–µ—Ä–≤—ã–º
dp.include_router(first_router)

# –≠—Ç–æ—Ç —Ö–µ–Ω–¥–ª–µ—Ä –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å—Å—è –≤—Ç–æ—Ä—ã–º
dp.include_router(second_router)
```

### –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Router

#### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ—É—Ç–µ—Ä–∞
```python
from aiogram import Router, F
from aiogram.filters import Command
from aiogram.types import Message

# –°–æ–∑–¥–∞–µ–º —Ä–æ—É—Ç–µ—Ä
user_router = Router()

# –î–æ–±–∞–≤–ª—è–µ–º —Ö–µ–Ω–¥–ª–µ—Ä—ã
@user_router.message(Command("start"))
async def cmd_start(message: Message):
    await message.answer("–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –±–æ—Ç!")

@user_router.message(Command("profile"))
async def cmd_profile(message: Message):
    await message.answer("–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å")

@user_router.message(F.text == "–ø–æ–º–æ—â—å")
async def cmd_help(message: Message):
    await message.answer("–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?")

@user_router.message(F.photo)
async def handle_photo(message: Message):
    await message.answer("–ü–æ–ª—É—á–∏–ª —Ñ–æ—Ç–æ!")
```

#### –®–∞–≥ 2: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –¥–∏—Å–ø–µ—Ç—á–µ—Ä—É
```python
from aiogram import Dispatcher

dp = Dispatcher()

# –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–æ—É—Ç–µ—Ä
dp.include_router(user_router)
```

#### –®–∞–≥ 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å middleware
```python
# Middleware –¥–ª—è —Ä–æ—É—Ç–µ—Ä–∞
@user_router.middleware()
async def user_middleware(handler, event, data):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if hasattr(event, 'from_user'):
        data["user_id"] = event.from_user.id
    return await handler(event, data)

# –•–µ–Ω–¥–ª–µ—Ä —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö –∏–∑ middleware
@user_router.message(Command("info"))
async def cmd_info(message: Message, user_id: int):
    await message.answer(f"–í–∞—à ID: {user_id}")
```

### –í–ª–æ–∂–µ–Ω–Ω—ã–µ —Ä–æ—É—Ç–µ—Ä—ã

–í–ª–æ–∂–µ–Ω–Ω—ã–µ —Ä–æ—É—Ç–µ—Ä—ã –ø–æ–∑–≤–æ–ª—è—é—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∏–µ—Ä–∞—Ä—Ö–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏:

```python
from aiogram import Router

# –ì–ª–∞–≤–Ω—ã–π —Ä–æ—É—Ç–µ—Ä
main_router = Router()

# –†–æ—É—Ç–µ—Ä—ã –≤—Ç–æ—Ä–æ–≥–æ —É—Ä–æ–≤–Ω—è
user_router = Router()
admin_router = Router()

# –†–æ—É—Ç–µ—Ä—ã —Ç—Ä–µ—Ç—å–µ–≥–æ —É—Ä–æ–≤–Ω—è
profile_router = Router()
settings_router = Router()

# –í–∫–ª–∞–¥—ã–≤–∞–µ–º —Ä–æ—É—Ç–µ—Ä—ã
user_router.include_router(profile_router)
user_router.include_router(settings_router)

main_router.include_router(user_router)
main_router.include_router(admin_router)

# –•–µ–Ω–¥–ª–µ—Ä—ã –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω—è—Ö
@main_router.message(Command("start"))
async def global_start(message: Message):
    await message.answer("–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ä—Ç")

@user_router.message(Command("user"))
async def user_command(message: Message):
    await message.answer("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∫–æ–º–∞–Ω–¥–∞")

@profile_router.message(Command("profile"))
async def profile_command(message: Message):
    await message.answer("–ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ—Ñ–∏–ª—è")
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ä–æ—É—Ç–µ—Ä–æ–≤:**
1. **–õ–æ–≥–∏—á–µ—Å–∫–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞**: —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤–º–µ—Å—Ç–µ
2. **–û–±—â–∏–µ middleware**: middleware —Ä–æ–¥–∏—Ç–µ–ª—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ –≤—Å–µ–º –¥–æ—á–µ—Ä–Ω–∏–º
3. **–ò–∑–æ–ª—è—Ü–∏—è**: –º–æ–∂–Ω–æ –ª–µ–≥–∫–æ –≤–∫–ª—é—á–∞—Ç—å/–æ—Ç–∫–ª—é—á–∞—Ç—å —Ü–µ–ª—ã–µ –≤–µ—Ç–∫–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —É—Ä–æ–≤–Ω–∏

### –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

#### 1. –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
–ì—Ä—É–ø–ø–∏—Ä—É–π—Ç–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã –ø–æ –∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—é:

```python
# –•–æ—Ä–æ—à–∏–π –ø—Ä–∏–º–µ—Ä
user_handlers.py      # –í—Å–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
admin_handlers.py     # –í—Å–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
payment_handlers.py   # –í—Å–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π

# –ü–ª–æ—Ö–æ–π –ø—Ä–∏–º–µ—Ä
handlers_part1.py     # –°–ª—É—á–∞–π–Ω—ã–π –Ω–∞–±–æ—Ä —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤
handlers_part2.py     # –ï—â–µ –æ–¥–∏–Ω —Å–ª—É—á–∞–π–Ω—ã–π –Ω–∞–±–æ—Ä
```

#### 2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ –∏–º–µ–Ω–∞
```python
# –•–æ—Ä–æ—à–∏–π –ø—Ä–∏–º–µ—Ä
user_profile_router = Router()
admin_stats_router = Router()
payment_create_router = Router()

# –ü–ª–æ—Ö–æ–π –ø—Ä–∏–º–µ—Ä
router1 = Router()
router2 = Router()
router3 = Router()
```

#### 3. –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Ä–æ—É—Ç–µ—Ä—ã
```python
"""
–†–æ—É—Ç–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥.

–í–∫–ª—é—á–∞–µ—Ç:
- –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã (start, help)
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–º
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
"""
user_router = Router()
```

#### 4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ä–æ—É—Ç–µ—Ä–∞
```python
# –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –∫–æ –≤—Å–µ–º—É —Ä–æ—É—Ç–µ—Ä—É
admin_router = Router()
admin_router.message.filter(AdminFilter())

@admin_router.message(Command("stats"))
async def admin_stats(message: Message):
    # –≠—Ç–æ—Ç —Ö–µ–Ω–¥–ª–µ—Ä –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
    pass
```

#### 5. –ò–∑–±–µ–≥–∞–π—Ç–µ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```python
# –ü–ª–æ—Ö–æ - —Ü–∏–∫–ª–∏—á–µ—Å–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
# user.py –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç admin.py
# admin.py –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç user.py

# –•–æ—Ä–æ—à–æ - –≤—ã–Ω–æ—Å–∏–º –æ–±—â–µ–µ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å
# user.py –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç common.py
# admin.py –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç common.py
```

---

## ‚ö° –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –≤ aiogram

### –ü–æ—á–µ–º—É –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–∞?

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –≤—ã —É–ø—Ä–∞–≤–ª—è–µ—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–º:
- **–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥**: –æ—Ñ–∏—Ü–∏–∞–Ω—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–∫–∞–∑, –æ—Ç–Ω–æ—Å–∏—Ç –µ–≥–æ –Ω–∞ –∫—É—Ö–Ω—é, –∂–¥–µ—Ç, –ø–æ–∫–∞ –ø—Ä–∏–≥–æ—Ç–æ–≤—è—Ç, –ø—Ä–∏–Ω–æ—Å–∏—Ç –±–ª—é–¥–æ, –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –∏–¥–µ—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å—Ç–æ–ª–∏–∫—É
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥**: –æ—Ñ–∏—Ü–∏–∞–Ω—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–∫–∞–∑, –æ—Ç–Ω–æ—Å–∏—Ç –Ω–∞ –∫—É—Ö–Ω—é, –∏ –ø–æ–∫–∞ –≥–æ—Ç–æ–≤–∏—Ç—Å—è ‚Äî –∏–¥–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–∫–∞–∑ —É –¥—Ä—É–≥–∏—Ö —Å—Ç–æ–ª–∏–∫–æ–≤

**–í –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–æ –∂–µ —Å–∞–º–æ–µ:**
```python
# –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–æ–¥ - –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
import time

def process_order(order):
    time.sleep(5)  # –ì–æ—Ç–æ–≤–∏–º –∑–∞–∫–∞–∑ 5 —Å–µ–∫—É–Ω–¥
    return f"–ó–∞–∫–∞–∑ {order} –≥–æ—Ç–æ–≤"

orders = ["–ü–∏—Ü—Ü–∞", "–°–∞–ª–∞—Ç", "–°—É–ø"]
for order in orders:
    result = process_order(order)
    print(result)
# –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 15 —Å–µ–∫—É–Ω–¥

# –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–æ–¥ - –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π
import asyncio

async def process_order_async(order):
    await asyncio.sleep(5)  # –ì–æ—Ç–æ–≤–∏–º –∑–∞–∫–∞–∑ 5 —Å–µ–∫—É–Ω–¥
    return f"–ó–∞–∫–∞–∑ {order} –≥–æ—Ç–æ–≤"

async def main():
    orders = ["–ü–∏—Ü—Ü–∞", "–°–∞–ª–∞—Ç", "–°—É–ø"]
    tasks = [process_order_async(order) for order in orders]
    results = await asyncio.gather(*tasks)
    for result in results:
        print(result)
# –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 5 —Å–µ–∫—É–Ω–¥
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏ –≤ aiogram:**
1. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –±–æ—Ç –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç—ã—Å—è—á–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
2. **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**: –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—Å—è –≤—Ä–µ–º—è –Ω–∞ –æ–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç API
3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: –ª–µ–≥–∫–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –¥—Ä—É–≥–∏–º–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –º–µ–Ω—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –Ω–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É

### –û—Å–Ω–æ–≤—ã async/await

#### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

1. **–ö–æ—Ä—É—Ç–∏–Ω—ã (coroutines)**: —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω—ã
2. **Event Loop**: —Ü–∏–∫–ª —Å–æ–±—ã—Ç–∏–π, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
3. **Await**: –æ–ø–µ—Ä–∞—Ç–æ—Ä –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
4. **Future**: –æ–±—ä–µ–∫—Ç, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏

#### –ü—Ä–∏–º–µ—Ä—ã

```python
import asyncio

# –ü—Ä–æ—Å—Ç–∞—è –∫–æ—Ä—É—Ç–∏–Ω–∞
async def say_hello():
    print("–ü—Ä–∏–≤–µ—Ç")
    await asyncio.sleep(1)
    print("–ú–∏—Ä")

# –ó–∞–ø—É—Å–∫ –∫–æ—Ä—É—Ç–∏–Ω—ã
async def main():
    await say_hello()

asyncio.run(main())
```

#### –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

```python
import asyncio

async def task1():
    print("–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏ 1")
    await asyncio.sleep(2)
    print("–ö–æ–Ω–µ—Ü –∑–∞–¥–∞—á–∏ 1")

async def task2():
    print("–ù–∞—á–∞–ª–æ –∑–∞–¥–∞—á–∏ 2")
    await asyncio.sleep(1)
    print("–ö–æ–Ω–µ—Ü –∑–∞–¥–∞—á–∏ 2")

async def main():
    # –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    print("–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ:")
    await task1()
    await task2()
    
    # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    print("\n–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ:")
    await asyncio.gather(task1(), task2())

asyncio.run(main())
```

### Event Loop

**Event Loop** ‚Äî —ç—Ç–æ —Å–µ—Ä–¥—Ü–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è. –≠—Ç–æ –∫–∞–∫ –¥–∏—Ä–∏–∂–µ—Ä –æ—Ä–∫–µ—Å—Ç—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ –º—É–∑—ã–∫–∞–Ω—Ç–∞–º–∏ (–∫–æ—Ä—É—Ç–∏–Ω–∞–º–∏) –∏ —Å–ª–µ–¥–∏—Ç, —á—Ç–æ–±—ã –æ–Ω–∏ –∏–≥—Ä–∞–ª–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è.

```python
import asyncio

async def musician(name, duration):
    print(f"{name} –Ω–∞—á–∏–Ω–∞–µ—Ç –∏–≥—Ä–∞—Ç—å")
    await asyncio.sleep(duration)
    print(f"{name} –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç –∏–≥—Ä–∞—Ç—å")

async def conductor():
    # –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á–∏ –¥–ª—è –≤—Å–µ—Ö –º—É–∑—ã–∫–∞–Ω—Ç–æ–≤
    tasks = [
        musician("–°–∫—Ä–∏–ø–∞—á", 2),
        musician("–ü–∏–∞–Ω–∏—Å—Ç", 3),
        musician("–í–∏–æ–ª–æ–Ω—á–µ–ª–∏—Å—Ç", 1)
    ]
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
    await asyncio.gather(*tasks)
    print("–ö–æ–Ω—Ü–µ—Ä—Ç –æ–∫–æ–Ω—á–µ–Ω!")

# –ó–∞–ø—É—Å–∫–∞–µ–º –¥–∏—Ä–∏–∂–µ—Ä–∞
asyncio.run(conductor())
```

### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –≤ aiogram

–í—Å–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã –≤ aiogram –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏:

```python
# –ü—Ä–∞–≤–∏–ª—å–Ω–æ - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ö–µ–Ω–¥–ª–µ—Ä
@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    await message.answer("–ü—Ä–∏–≤–µ—Ç!")

# –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ - —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ö–µ–Ω–¥–ª–µ—Ä
@dp.message(Command("help"))
def cmd_help(message: types.Message):
    # –≠—Ç–æ –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É!
    message.answer("–ü–æ–º–æ—â—å")
```

**–ü–æ—á–µ–º—É –≤—Å–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º?**
1. **–ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**: –æ–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Telegram –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –±–æ—Ç–∞
2. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**: –±–æ—Ç –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏**: –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, HTTP-–∫–ª–∏–µ–Ω—Ç—ã –∏ —Ç.–¥.

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ø–æ–≤—ã—à–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–æ—Ç–æ–≤:

```python
import asyncio
import time
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command

# –°–æ–∑–¥–∞–µ–º –±–æ—Ç–∞
bot = Bot(token="YOUR_TOKEN")
dp = Dispatcher()

# –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ö–µ–Ω–¥–ª–µ—Ä —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
@dp.message(Command("delay"))
async def cmd_delay(message: types.Message):
    await asyncio.sleep(5)  # –ò–º–∏—Ç–∞—Ü–∏—è –¥–æ–ª–≥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
    await message.answer("–ì–æ—Ç–æ–≤–æ!")

# –¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
async def test_performance():
    start_time = time.time()
    
    # –°–æ–∑–¥–∞–µ–º 10 —Å–æ–æ–±—â–µ–Ω–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
    tasks = []
    for i in range(10):
        message = types.Message(
            message_id=i,
            date=int(time.time()),
            chat=types.Chat(id=123, type="private"),
            from_user=types.User(id=456, is_bot=False, first_name="Test"),
            text="/delay"
        )
        tasks.append(dp.feed_update(types.Update(update_id=i, message=message)))
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
    await asyncio.gather(*tasks)
    
    end_time = time.time()
    print(f"–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {end_time - start_time:.2f} —Å–µ–∫—É–Ω–¥")

asyncio.run(test_performance())
# –†–µ–∑—É–ª—å—Ç–∞—Ç: ~5 —Å–µ–∫—É–Ω–¥ (–Ω–µ 50!)
```

### –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏

#### 1. –°–º–µ—à–∏–≤–∞–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞

```python
# –ü–ª–æ—Ö–æ - –±–ª–æ–∫–∏—Ä—É—é—â–∏–π –≤—ã–∑–æ–≤ –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–¥–µ
@dp.message(Command("data"))
async def cmd_data(message: types.Message):
    # time.sleep –±–ª–æ–∫–∏—Ä—É–µ—Ç event loop!
    time.sleep(5)
    await message.answer("–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã")

# –•–æ—Ä–æ—à–æ - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
@dp.message(Command("data"))
async def cmd_data(message: types.Message):
    await asyncio.sleep(5)  # –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
    await message.answer("–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã")
```

#### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ await

```python
# –ü–ª–æ—Ö–æ - –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç await
@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    message.answer("–ü—Ä–∏–≤–µ—Ç!")  # –ù–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!

# –•–æ—Ä–æ—à–æ - —Å await
@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    await message.answer("–ü—Ä–∏–≤–µ—Ç!")
```

#### 3. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ asyncio.run()

```python
# –ü–ª–æ—Ö–æ - –∑–∞–ø—É—Å–∫ event loop –≤–Ω—É—Ç—Ä–∏ event loop
@dp.message(Command("test"))
async def cmd_test(message: types.Message):
    asyncio.run(some_async_function())  # –û—à–∏–±–∫–∞!

# –•–æ—Ä–æ—à–æ - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ await
@dp.message(Command("test"))
async def cmd_test(message: types.Message):
    await some_async_function()
```

#### 4. –ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

```python
# –ü–ª–æ—Ö–æ - –±–ª–æ–∫–∏—Ä—É—é—â–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è —Å —Ñ–∞–π–ª–∞–º–∏
@dp.message(Command("file"))
async def cmd_file(message: types.Message):
    with open("large_file.txt", "r") as f:  # –ë–ª–æ–∫–∏—Ä—É–µ—Ç!
        data = f.read()
    await message.answer("–§–∞–π–ª –ø—Ä–æ—á–∏—Ç–∞–Ω")

# –•–æ—Ä–æ—à–æ - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏
import aiofiles

@dp.message(Command("file"))
async def cmd_file(message: types.Message):
    async with aiofiles.open("large_file.txt", "r") as f:
        data = await f.read()
    await message.answer("–§–∞–π–ª –ø—Ä–æ—á–∏—Ç–∞–Ω")
```

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

### –ü–æ—á–µ–º—É –≤–∞–∂–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞?

–ö–æ–≥–¥–∞ –≤—ã —Å–æ–∑–¥–∞–µ—Ç–µ –ø—Ä–æ—Å—Ç–æ–≥–æ –±–æ—Ç–∞ —Å 10 —Ö–µ–Ω–¥–ª–µ—Ä–∞–º–∏, –º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –≤—Å–µ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ. –ù–æ –∫–æ–≥–¥–∞ –ø—Ä–æ–µ–∫—Ç —Ä–∞—Å—Ç–µ—Ç:
- **–ü—É—Ç–∞–Ω–∏—Ü–∞ –≤ –∫–æ–¥–µ**: —Ç—Ä—É–¥–Ω–æ –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
- **–°–ª–æ–∂–Ω–æ—Å—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫–µ**: –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å –¥—Ä—É–≥–æ–µ
- **–ü—Ä–æ–±–ª–µ–º—ã —Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º**: —Å–ª–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π –∫–æ–¥
- **–¢—Ä—É–¥–Ω–æ—Å—Ç–∏ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**: —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–µ—à–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É

**–•–æ—Ä–æ—à–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ—à–∞–µ—Ç —ç—Ç–∏ –ø—Ä–æ–±–ª–µ–º—ã:**
- **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å**: –∫–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–≤–æ—é –æ–±–ª–∞—Å—Ç—å
- **–ò–∑–æ–ª—è—Ü–∏—è**: –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–º –º–æ–¥—É–ª–µ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ –¥—Ä—É–≥–∏–µ
- **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å**: –∫–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
my_bot/
‚îú‚îÄ‚îÄ venv/                           # –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ .env                             # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ .gitignore                       # –§–∞–π–ª—ã –¥–ª—è Git
‚îú‚îÄ‚îÄ requirements.txt                 # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ bot.py                           # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ config.py                        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ README.md                        # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îÇ
‚îú‚îÄ‚îÄ handlers/                        # –•–µ–Ω–¥–ª–µ—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ user/                        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py                  # –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ profile.py               # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–º
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings.py              # –ù–∞—Å—Ç—Ä–æ–π–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ admin/                       # –ê–¥–º–∏–Ω—Å–∫–∏–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stats.py                 # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ manage.py                # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ broadcast.py             # –†–∞—Å—Å—ã–ª–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ payment/                     # –ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îú‚îÄ‚îÄ create.py                # –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
‚îÇ       ‚îî‚îÄ‚îÄ check.py                 # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–∞
‚îÇ
‚îú‚îÄ‚îÄ keyboards/                       # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ user_keyboards.py            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ admin_keyboards.py           # –ê–¥–º–∏–Ω—Å–∫–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îî‚îÄ‚îÄ payment_keyboards.py         # –ü–ª–∞—Ç–µ–∂–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ
‚îú‚îÄ‚îÄ services/                        # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ user_service.py              # –°–µ—Ä–≤–∏—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ payment_service.py           # –°–µ—Ä–≤–∏—Å –ø–ª–∞—Ç–µ–∂–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ notification_service.py      # –°–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
‚îÇ   ‚îî‚îÄ‚îÄ database.py                  # –†–∞–±–æ—Ç–∞ —Å –ë–î
‚îÇ
‚îú‚îÄ‚îÄ models/                          # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ user.py                      # –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ   ‚îú‚îÄ‚îÄ payment.py                   # –ú–æ–¥–µ–ª—å –ø–ª–∞—Ç–µ–∂–∞
‚îÇ   ‚îî‚îÄ‚îÄ database.py                  # –ú–æ–¥–µ–ª–∏ –ë–î
‚îÇ
‚îú‚îÄ‚îÄ utils/                           # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ decorators.py                # –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ helpers.py                   # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ validators.py                # –í–∞–ª–∏–¥–∞—Ç–æ—Ä—ã
‚îÇ   ‚îî‚îÄ‚îÄ formatters.py               # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ
‚îú‚îÄ‚îÄ middlewares/                     # –ú–∏–¥–ª–≤–∞—Ä–∏
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ auth_middleware.py           # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ logging_middleware.py        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îî‚îÄ‚îÄ throttling_middleware.py     # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã
‚îÇ
‚îú‚îÄ‚îÄ filters/                         # –§–∏–ª—å—Ç—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ admin_filter.py              # –§–∏–ª—å—Ç—Ä –∞–¥–º–∏–Ω–∞
‚îÇ   ‚îú‚îÄ‚îÄ user_filter.py               # –§–∏–ª—å—Ç—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ   ‚îî‚îÄ‚îÄ payment_filter.py            # –§–∏–ª—å—Ç—Ä –ø–ª–∞—Ç–µ–∂–µ–π
‚îÇ
‚îú‚îÄ‚îÄ database/                        # –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ connection.py                # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ migrations/                  # –ú–∏–≥—Ä–∞—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ seeds/                       # –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
‚îÇ
‚îú‚îÄ‚îÄ tests/                           # –¢–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ test_handlers.py             # –¢–µ—Å—Ç—ã —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ test_services.py             # –¢–µ—Å—Ç—ã —Å–µ—Ä–≤–∏—Å–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ fixtures/                   # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
‚îÇ
‚îú‚îÄ‚îÄ static/                          # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
‚îÇ   ‚îú‚îÄ‚îÄ images/                      # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ documents/                   # –î–æ–∫—É–º–µ–Ω—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ audio/                       # –ê—É–¥–∏–æ
‚îÇ
‚îî‚îÄ‚îÄ logs/                            # –õ–æ–≥–∏
    ‚îú‚îÄ‚îÄ bot.log                      # –õ–æ–≥ –±–æ—Ç–∞
    ‚îî‚îÄ‚îÄ errors.log                   # –õ–æ–≥ –æ—à–∏–±–æ–∫
```

### –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

#### 1. –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (bot.py)
```python
import asyncio
import logging
import os
from dotenv import load_dotenv

from aiogram import Bot, Dispatcher
from aiogram.fsm.storage.memory import MemoryStorage

from config import Config
from handlers.user import user_router
from handlers.admin import admin_router
from handlers.payment import payment_router
from middlewares.auth import AuthMiddleware
from middlewares.logging import LoggingMiddleware

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
config = Config()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
bot = Bot(token=config.BOT_TOKEN)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)

# –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–æ—É—Ç–µ—Ä—ã
dp.include_router(user_router)
dp.include_router(admin_router)
dp.include_router(payment_router)

# –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º middleware
dp.update.outer_middleware(LoggingMiddleware())
dp.update.middleware(AuthMiddleware())

async def main():
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    logging.info("Starting bot")
    await dp.start_polling(bot)
    logging.info("Bot stopped")

if __name__ == "__main__":
    asyncio.run(main())
```

#### 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (config.py)
```python
import os
from dataclasses import dataclass
from typing import Optional

@dataclass
class DatabaseConfig:
    host: str
    port: int
    user: str
    password: str
    database: str

@dataclass
class Config:
    BOT_TOKEN: str
    DATABASE: DatabaseConfig
    ADMIN_IDS: list[int]
    PAYMENT_TOKEN: Optional[str] = None
    
    @classmethod
    def from_env(cls):
        return cls(
            BOT_TOKEN=os.getenv("BOT_TOKEN"),
            DATABASE=DatabaseConfig(
                host=os.getenv("DB_HOST", "localhost"),
                port=int(os.getenv("DB_PORT", 5432)),
                user=os.getenv("DB_USER", "postgres"),
                password=os.getenv("DB_PASSWORD", ""),
                database=os.getenv("DB_NAME", "bot_db")
            ),
            ADMIN_IDS=list(map(int, os.getenv("ADMIN_IDS", "").split(","))),
            PAYMENT_TOKEN=os.getenv("PAYMENT_TOKEN")
        )
```

#### 3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã (handlers/user/base.py)
```python
from aiogram import Router, F
from aiogram.filters import Command
from aiogram.types import Message

from services.user_service import UserService
from keyboards.user_keyboards import get_main_keyboard

user_router = Router()

@user_router.message(Command("start"))
async def cmd_start(message: Message, user_service: UserService):
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await user_service.register_user(message.from_user)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    await message.answer(
        "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç–∞!\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=get_main_keyboard()
    )

@user_router.message(Command("help"))
async def cmd_help(message: Message):
    help_text = """
ü§ñ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É
/profile - –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å
/settings - –ù–∞—Å—Ç—Ä–æ–π–∫–∏
/help - –≠—Ç–∞ –ø–æ–º–æ—â—å

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏!
    """
    await message.answer(help_text)

@user_router.message(F.text == "üë§ –ü—Ä–æ—Ñ–∏–ª—å")
async def btn_profile(message: Message, user_service: UserService):
    user = await user_service.get_user(message.from_user.id)
    await message.answer(
        f"üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:\n\n"
        f"ID: {user.id}\n"
        f"–ò–º—è: {user.full_name}\n"
        f"Username: @{user.username}\n"
        f"–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: {user.created_at.strftime('%d.%m.%Y')}"
    )
```

#### 4. –°–µ—Ä–≤–∏—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (services/user_service.py)
```python
from datetime import datetime
from typing import Optional

from models.user import User
from database.connection import get_db_session

class UserService:
    def __init__(self, db_session):
        self.db = db_session
    
    async def register_user(self, telegram_user) -> User:
        """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        user = await self.get_user(telegram_user.id)
        
        if user:
            # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user.full_name = telegram_user.full_name
            user.username = telegram_user.username
            await self.db.commit()
            return user
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user = User(
            id=telegram_user.id,
            full_name=telegram_user.full_name,
            username=telegram_user.username,
            created_at=datetime.utcnow()
        )
        self.db.add(user)
        await self.db.commit()
        await self.db.refresh(user)
        return user
    
    async def get_user(self, user_id: int) -> Optional[User]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID"""
        result = await self.db.execute(
            select(User).where(User.id == user_id)
        )
        return result.scalar_one_or_none()
    
    async def update_user(self, user_id: int, **kwargs) -> Optional[User]:
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        user = await self.get_user(user_id)
        if not user:
            return None
        
        for key, value in kwargs.items():
            if hasattr(user, key):
                setattr(user, key, value)
        
        await self.db.commit()
        await self.db.refresh(user)
        return user
```

#### 5. –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (models/user.py)
```python
from datetime import datetime
from sqlalchemy import Column, Integer, String, DateTime
from sqlalchemy.ext.declarative import declarative_base

Base = declarative_base()

class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True)
    full_name = Column(String, nullable=False)
    username = Column(String, nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    def __repr__(self):
        return f"<User(id={self.id}, full_name='{self.full_name}')>"
```

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

–ö–æ–≥–¥–∞ –ø—Ä–æ–µ–∫—Ç —Ä–∞—Å—Ç–µ—Ç, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∞:

#### 1. –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
```
my_bot_microservices/
‚îú‚îÄ‚îÄ user_service/           # –°–µ—Ä–≤–∏—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îú‚îÄ‚îÄ payment_service/        # –°–µ—Ä–≤–∏—Å –ø–ª–∞—Ç–µ–∂–µ–π
‚îú‚îÄ‚îÄ notification_service/   # –°–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
‚îî‚îÄ‚îÄ bot_service/           # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –±–æ—Ç–∞
```

#### 2. Domain-Driven Design
```
my_bot_ddd/
‚îú‚îÄ‚îÄ domains/
‚îÇ   ‚îú‚îÄ‚îÄ user/              # –î–æ–º–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ payment/           # –î–æ–º–µ–Ω –ø–ª–∞—Ç–µ–∂–µ–π
‚îÇ   ‚îî‚îÄ‚îÄ notification/      # –î–æ–º–µ–Ω —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
‚îú‚îÄ‚îÄ infrastructure/        # –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
‚îî‚îÄ‚îÄ application/           # –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
```

#### 3. Feature-Sliced Structure
```
my_bot_fsd/
‚îú‚îÄ‚îÄ entities/              # –°—É—â–Ω–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ features/              # –§–∏—á–∏
‚îú‚îÄ‚îÄ shared/                # –û–±—â–∏–π –∫–æ–¥
‚îî‚îÄ‚îÄ app/                   # –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
```

---

## üß© Dependency Injection (DI)

### –ß—Ç–æ —Ç–∞–∫–æ–µ DI?

**Dependency Injection (DI)** ‚Äî —ç—Ç–æ –ø–∞—Ç—Ç–µ—Ä–Ω –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–±—ä–µ–∫—Ç–∞ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –∏–∑–≤–Ω–µ, –∞ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Å–∞–º–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞.

**–ê–Ω–∞–ª–æ–≥–∏—è –∏–∑ –∂–∏–∑–Ω–∏:**
–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –≤—ã —Å—Ç—Ä–æ–∏—Ç–µ –¥–æ–º:
- **–ë–µ–∑ DI**: –≤—ã —Å–∞–º–∏ –≤—ã—Ä–∞—â–∏–≤–∞–µ—Ç–µ –¥–µ—Ä–µ–≤–æ, –¥–µ–ª–∞–µ—Ç–µ –∫–∏—Ä–ø–∏—á–∏, –¥–æ–±—ã–≤–∞–µ—Ç–µ –º–µ—Ç–∞–ª–ª –¥–ª—è —Ç—Ä—É–±
- **–° DI**: –≤—ã –Ω–∞–Ω–∏–º–∞–µ—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ (–ø–ª–æ—Ç–Ω–∏–∫–∞, —Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞, —ç–ª–µ–∫—Ç—Ä–∏–∫–∞), –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–Ω–æ—Å—è—Ç —Å–≤–æ–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

**–í –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–∏:**
```python
# –ë–µ–∑ DI - –∂–µ—Å—Ç–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
class UserService:
    def __init__(self):
        self.db = MySQLConnection()  # –ñ–µ—Å—Ç–∫–æ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ MySQL
    
    def get_user(self, user_id):
        return self.db.query("SELECT * FROM users WHERE id = ?", user_id)

# –° DI - –≥–∏–±–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
class UserService:
    def __init__(self, db_connection):  # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∏–∑–≤–Ω–µ
        self.db = db_connection
    
    def get_user(self, user_id):
        return self.db.query("SELECT * FROM users WHERE id = ?", user_id)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
mysql_service = UserService(MySQLConnection())
postgres_service = UserService(PostgreSQLConnection())
test_service = UserService(MockConnection())
```

### –ü—Ä–∏–Ω—Ü–∏–ø—ã DI

#### 1. –ò–Ω–≤–µ—Ä—Å–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (Inversion of Control)
–í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –º—ã –ø–µ—Ä–µ–¥–∞–µ–º —ç—Ç–æ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–Ω–µ—à–Ω–µ–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É.

#### 2. –ü—Ä–∏–Ω—Ü–∏–ø –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (SRP)
–ö–∞–∂–¥—ã–π –∫–ª–∞—Å—Å –¥–æ–ª–∂–µ–Ω –∑–∞–Ω–∏–º–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏–º –¥–µ–ª–æ–º. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ‚Äî –Ω–µ –µ–≥–æ –∑–∞–¥–∞—á–∞.

#### 3. –ü—Ä–∏–Ω—Ü–∏–ø –æ—Ç–∫—Ä—ã—Ç–æ—Å—Ç–∏/–∑–∞–∫—Ä—ã—Ç–æ—Å—Ç–∏ (OCP)
–ö–ª–∞—Å—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è, –Ω–æ –∑–∞–∫—Ä—ã—Ç –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è. DI –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–µ–Ω—è—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞ –∫–ª–∞—Å—Å–∞.

#### 4. –ü—Ä–∏–Ω—Ü–∏–ø –∏–Ω–≤–µ—Ä—Å–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (DIP)
–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è—Ö, –∞ –Ω–µ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è—Ö.

```python
# –ü–ª–æ—Ö–æ - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
class UserService:
    def __init__(self):
        self.db = MySQLConnection()  # –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

# –•–æ—Ä–æ—à–æ - –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏
from abc import ABC, abstractmethod

class DatabaseConnection(ABC):
    @abstractmethod
    def query(self, sql: str, params: tuple = None):
        pass

class MySQLConnection(DatabaseConnection):
    def query(self, sql: str, params: tuple = None):
        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è MySQL
        pass

class UserService:
    def __init__(self, db: DatabaseConnection):  # –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è
        self.db = db
```

### DI –≤ aiogram

Aiogram 3.x –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É DI —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–Ω–µ–¥—Ä—è—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ —Ö–µ–Ω–¥–ª–µ—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

#### –û—Å–Ω–æ–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:

##### 1. –ß–µ—Ä–µ–∑ middleware

```python
from aiogram import Bot, Dispatcher
from services.user_service import UserService

async def user_service_middleware(handler, event, data):
    # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º —Å–µ—Ä–≤–∏—Å
    user_service = UserService(db_connection=data["db"])
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    data["user_service"] = user_service
    
    return await handler(event, data)

# –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º middleware
dp.update.middleware(user_service_middleware)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ö–µ–Ω–¥–ª–µ—Ä–µ
@dp.message(Command("profile"))
async def cmd_profile(message: Message, user_service: UserService):
    user = await user_service.get_user(message.from_user.id)
    await message.answer(f"–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å: {user}")
```

##### 2. –ß–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞

```python
from aiogram import Bot, Dispatcher
from services.user_service import UserService

# –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å
user_service = UserService(db_connection=db)

# –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
dp["user_service"] = user_service

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ö–µ–Ω–¥–ª–µ—Ä–µ
@dp.message(Command("profile"))
async def cmd_profile(message: Message):
    user_service = dp["user_service"]
    user = await user_service.get_user(message.from_user.id)
    await message.answer(f"–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å: {user}")
```

##### 3. –ß–µ—Ä–µ–∑ —Ñ–∞–±—Ä–∏–∫—É (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ø–æ—Å–æ–±)

```python
from aiogram import Bot, Dispatcher
from aiogram.fsm.context import FSMContext
from aiogram.fsm.storage.memory import MemoryStorage
from services.user_service import UserService

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
storage = MemoryStorage()

# –§–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
async def user_service_factory(
    bot: Bot,
    dispatcher: Dispatcher,
    event: types.Update,
    **kwargs
) -> UserService:
    return UserService(db_connection=dispatcher["db"])

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ñ–∞–±—Ä–∏–∫–∏
dp.update.register(user_service_factory, UserService)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ö–µ–Ω–¥–ª–µ—Ä–µ
@dp.message(Command("profile"))
async def cmd_profile(message: Message, user_service: UserService):
    user = await user_service.get_user(message.from_user.id)
    await message.answer(f"–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å: {user}")
```

### –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã

#### –ü—Ä–∏–º–µ—Ä 1: –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```python
# database/connection.py
import asyncpg
from contextlib import asynccontextmanager

class DatabaseConnection:
    def __init__(self, dsn: str):
        self.dsn = dsn
        self.pool = None
    
    async def connect(self):
        self.pool = await asyncpg.create_pool(self.dsn)
    
    async def disconnect(self):
        if self.pool:
            await self.pool.close()
    
    @asynccontextmanager
    async def get_connection(self):
        async with self.pool.acquire() as connection:
            yield connection

# services/user_service.py
class UserService:
    def __init__(self, db: DatabaseConnection):
        self.db = db
    
    async def get_user(self, user_id: int):
        async with self.db.get_connection() as conn:
            record = await conn.fetchrow(
                "SELECT * FROM users WHERE id = $1",
                user_id
            )
            return dict(record) if record else None

# bot.py
async def db_factory(bot: Bot, **kwargs) -> DatabaseConnection:
    db = DatabaseConnection("postgresql://user:pass@localhost/db")
    await db.connect()
    return db

dp.update.register(db_factory, DatabaseConnection)
```

#### –ü—Ä–∏–º–µ—Ä 2: –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

```python
# services/notification_service.py
class NotificationService:
    def __init__(self, bot: Bot):
        self.bot = bot
    
    async def send_notification(self, user_id: int, text: str):
        await self.bot.send_message(user_id, text)

# services/payment_service.py
class PaymentService:
    def __init__(self, api_key: str):
        self.api_key = api_key
    
    async def create_payment(self, amount: float):
        # –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
        pass

# bot.py
async def notification_service_factory(bot: Bot, **kwargs) -> NotificationService:
    return NotificationService(bot)

async def payment_service_factory(**kwargs) -> PaymentService:
    return PaymentService(api_key="your_api_key")

dp.update.register(notification_service_factory, NotificationService)
dp.update.register(payment_service_factory, PaymentService)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ö–µ–Ω–¥–ª–µ—Ä–µ
@dp.message(Command("pay"))
async def cmd_pay(
    message: Message,
    notification_service: NotificationService,
    payment_service: PaymentService
):
    payment = await payment_service.create_payment(100.0)
    await notification_service.send_notification(
        message.from_user.id,
        f"–ü–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–Ω: {payment.id}"
    )
```

### –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã

#### 1. Scoped –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```python
from contextvars import ContextVar

request_context = ContextVar("request_context")

class ScopedUserService:
    def __init__(self):
        self._context = request_context.get()
    
    async def get_user(self, user_id: int):
        return await self._context["db"].fetchrow(
            "SELECT * FROM users WHERE id = $1",
            user_id
        )

async def scoped_user_service_factory(**kwargs) -> ScopedUserService:
    return ScopedUserService()

@dp.update.outer_middleware
async def context_middleware(handler, event, data):
    # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
    context = {"db": data["db"]}
    request_context.set(context)
    
    try:
        return await handler(event, data)
    finally:
        request_context.set({})
```

#### 2. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```python
from functools import lru_cache

class CachedUserService:
    def __init__(self, db_connection):
        self.db = db_connection
        self._cache = {}
    
    async def get_user(self, user_id: int):
        if user_id in self._cache:
            return self._cache[user_id]
        
        user = await self.db.fetchrow(
            "SELECT * FROM users WHERE id = $1",
            user_id
        )
        self._cache[user_id] = dict(user) if user else None
        return self._cache[user_id]

@lru_cache(maxsize=128)
def get_user_service(db_connection) -> CachedUserService:
    return CachedUserService(db_connection)
```

#### 3. –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```python
from dataclasses import dataclass
from typing import Optional

@dataclass
class BotConfig:
    token: str
    admin_ids: list[int]
    payment_token: Optional[str] = None

@dataclass
class DatabaseConfig:
    host: str
    port: int
    user: str
    password: str
    database: str

async def config_factory(**kwargs) -> BotConfig:
    return BotConfig(
        token=os.getenv("BOT_TOKEN"),
        admin_ids=list(map(int, os.getenv("ADMIN_IDS", "").split(","))),
        payment_token=os.getenv("PAYMENT_TOKEN")
    )

async def db_config_factory(**kwargs) -> DatabaseConfig:
    return DatabaseConfig(
        host=os.getenv("DB_HOST"),
        port=int(os.getenv("DB_PORT")),
        user=os.getenv("DB_USER"),
        password=os.getenv("DB_PASSWORD"),
        database=os.getenv("DB_NAME")
    )

dp.update.register(config_factory, BotConfig)
dp.update.register(db_config_factory, DatabaseConfig)
```

> üí° **–î–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è DI** —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª [06-dip.md](06-dip.md) –∏–∑ –Ω–∞—à–µ–≥–æ –∫—É—Ä—Å–∞ –ø–æ SOLID –ø—Ä–∏–Ω—Ü–∏–ø–∞–º. –¢–∞–º –≤—ã –Ω–∞–π–¥–µ—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ Dependency Inversion Principle –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã.

---

## üìù –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∫–æ–¥–∞

–î–∞–≤–∞–π—Ç–µ —Å–æ–±–µ—Ä–µ–º –≤—Å–µ –≤–º–µ—Å—Ç–µ –≤ –ø–æ–ª–Ω–æ–º –ø—Ä–∏–º–µ—Ä–µ:

```python
import asyncio
import logging
import os
from contextlib import asynccontextmanager
from dataclasses import dataclass
from typing import Optional

import asyncpg
from aiogram import Bot, Dispatcher, Router, F, types
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.storage.memory import MemoryStorage

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
@dataclass
class Config:
    BOT_TOKEN: str
    DATABASE_URL: str
    ADMIN_IDS: list[int]

config = Config(
    BOT_TOKEN=os.getenv("BOT_TOKEN", "YOUR_TOKEN"),
    DATABASE_URL=os.getenv("DATABASE_URL", "postgresql://user:pass@localhost/db"),
    ADMIN_IDS=list(map(int, os.getenv("ADMIN_IDS", "123456789").split(",")))
)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
bot = Bot(token=config.BOT_TOKEN)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)

# –†–æ—É—Ç–µ—Ä—ã
user_router = Router()
admin_router = Router()

# –°–µ—Ä–≤–∏—Å—ã
class DatabaseService:
    def __init__(self, dsn: str):
        self.dsn = dsn
        self.pool = None
    
    async def connect(self):
        self.pool = await asyncpg.create_pool(self.dsn)
    
    async def disconnect(self):
        if self.pool:
            await self.pool.close()
    
    @asynccontextmanager
    async def get_connection(self):
        async with self.pool.acquire() as conn:
            yield conn

class UserService:
    def __init__(self, db: DatabaseService):
        self.db = db
    
    async def get_user(self, user_id: int):
        async with self.db.get_connection() as conn:
            record = await conn.fetchrow(
                "SELECT * FROM users WHERE id = $1",
                user_id
            )
            return dict(record) if record else None
    
    async def create_user(self, user_data: dict):
        async with self.db.get_connection() as conn:
            await conn.execute(
                """
                INSERT INTO users (id, full_name, username, created_at)
                VALUES ($1, $2, $3, NOW())
                ON CONFLICT (id) DO UPDATE
                SET full_name = $2, username = $3
                """,
                user_data["id"],
                user_data["full_name"],
                user_data["username"]
            )

class NotificationService:
    def __init__(self, bot: Bot):
        self.bot = bot
    
    async def notify_admins(self, text: str):
        for admin_id in config.ADMIN_IDS:
            try:
                await self.bot.send_message(admin_id, text)
            except Exception as e:
                logging.error(f"Failed to notify admin {admin_id}: {e}")

# –§–∞–±—Ä–∏–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
async def db_factory(**kwargs) -> DatabaseService:
    db = DatabaseService(config.DATABASE_URL)
    await db.connect()
    return db

async def user_service_factory(db: DatabaseService, **kwargs) -> UserService:
    return UserService(db)

async def notification_service_factory(bot: Bot, **kwargs) -> NotificationService:
    return NotificationService(bot)

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ñ–∞–±—Ä–∏–∫
dp.update.register(db_factory, DatabaseService)
dp.update.register(user_service_factory, UserService)
dp.update.register(notification_service_factory, NotificationService)

# Middleware
@dp.update.outer_middleware
async def logging_middleware(handler, event, data):
    logging.info(f"Update: {event.update_type}")
    return await handler(event, data)

@dp.update.middleware
async def user_registration_middleware(handler, event, data):
    if hasattr(event, 'message') and event.message:
        user_service = data["user_service"]
        await user_service.create_user({
            "id": event.message.from_user.id,
            "full_name": event.message.from_user.full_name,
            "username": event.message.from_user.username
        })
    
    return await handler(event, data)

# –•–µ–Ω–¥–ª–µ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
@user_router.message(Command("start"))
async def cmd_start(
    message: types.Message,
    user_service: UserService,
    notification_service: NotificationService
):
    user = await user_service.get_user(message.from_user.id)
    
    await message.answer(
        f"üëã –ü—Ä–∏–≤–µ—Ç, {message.from_user.full_name}!\n\n"
        f"–í–∞—à ID: {message.from_user.id}\n"
        f"–í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã: {'–î–∞' if user else '–ù–µ—Ç'}"
    )
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤
    await notification_service.notify_admins(
        f"–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {message.from_user.full_name} (@{message.from_user.username})"
    )

@user_router.message(Command("profile"))
async def cmd_profile(message: types.Message, user_service: UserService):
    user = await user_service.get_user(message.from_user.id)
    
    if user:
        await message.answer(
            f"üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:\n\n"
            f"ID: {user['id']}\n"
            f"–ò–º—è: {user['full_name']}\n"
            f"Username: @{user['username']}\n"
            f"–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: {user['created_at']}"
        )
    else:
        await message.answer("–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")

# –•–µ–Ω–¥–ª–µ—Ä—ã –∞–¥–º–∏–Ω–æ–≤
@admin_router.message(Command("stats"))
async def cmd_stats(
    message: types.Message,
    db: DatabaseService,
    user_service: UserService
):
    if message.from_user.id not in config.ADMIN_IDS:
        await message.answer("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    async with db.get_connection() as conn:
        users_count = await conn.fetchval("SELECT COUNT(*) FROM users")
    
    await message.answer(
        f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞:\n\n"
        f"–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {users_count}"
    )

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ—É—Ç–µ—Ä–æ–≤
dp.include_router(user_router)
dp.include_router(admin_router)

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
async def main():
    logging.info("Starting bot")
    try:
        await dp.start_polling(bot)
    finally:
        logging.info("Stopping bot")
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        if "db" in dp.workflow_data:
            await dp.workflow_data["db"].disconnect()

if __name__ == "__main__":
    asyncio.run(main())
```

---

## ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–Ω–∞—á–∞–ª–∞ –∏–∑–º–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

```python
import time
import cProfile
import pstats
from contextlib import asynccontextmanager

@asynccontextmanager
async def profile_handler(handler_name: str):
    profiler = cProfile.Profile()
    profiler.enable()
    start_time = time.time()
    
    try:
        yield
    finally:
        profiler.disable()
        end_time = time.time()
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        stats = pstats.Stats(profiler)
        stats.sort_stats('cumulative')
        stats.print_stats()
        
        logging.info(f"Handler {handler_name} took {end_time - start_time:.2f} seconds")

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ö–µ–Ω–¥–ª–µ—Ä–µ
@dp.message(Command("profile_test"))
async def cmd_profile_test(message: types.Message):
    async with profile_handler("profile_test"):
        # –¢—è–∂–µ–ª–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
        result = 0
        for i in range(1000000):
            result += i
        await message.answer(f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {result}")
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

#### 1. –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

```python
# –ü–ª–æ—Ö–æ - –º–Ω–æ–∂–µ—Å—Ç–≤–æ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
@dp.message(Command("batch_bad"))
async def cmd_batch_bad(message: types.Message, db: DatabaseService):
    user_ids = [1, 2, 3, 4, 5]
    users = []
    
    for user_id in user_ids:
        user = await db.fetchrow("SELECT * FROM users WHERE id = $1", user_id)
        users.append(user)
    
    await message.answer(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: {len(users)}")

# –•–æ—Ä–æ—à–æ - –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å —Å IN
@dp.message(Command("batch_good"))
async def cmd_batch_good(message: types.Message, db: DatabaseService):
    user_ids = [1, 2, 3, 4, 5]
    users = await db.fetch(
        "SELECT * FROM users WHERE id = ANY($1)",
        user_ids
    )
    
    await message.answer(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: {len(users)}")
```

#### 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

```python
# –ü–ª–æ—Ö–æ - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
@dp.message(Command("connection_bad"))
async def cmd_connection_bad(message: types.Message):
    conn = await asyncpg.connect(config.DATABASE_URL)
    user = await conn.fetchrow("SELECT * FROM users WHERE id = $1", message.from_user.id)
    await conn.close()
    await message.answer(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user}")

# –•–æ—Ä–æ—à–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
@dp.message(Command("connection_good"))
async def cmd_connection_good(message: types.Message, db: DatabaseService):
    async with db.get_connection() as conn:
        user = await conn.fetchrow("SELECT * FROM users WHERE id = $1", message.from_user.id)
    await message.answer(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user}")
```

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

#### 1. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏

```python
from functools import lru_cache

class CachedUserService:
    def __init__(self, db: DatabaseService):
        self.db = db
    
    @lru_cache(maxsize=1000)
    async def get_user(self, user_id: int):
        async with self.db.get_connection() as conn:
            user = await conn.fetchrow("SELECT * FROM users WHERE id = $1", user_id)
            return dict(user) if user else None
    
    def invalidate_cache(self, user_id: int):
        self.get_user.cache_invalidate(user_id)
```

#### 2. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Redis

```python
import aioredis

class RedisCache:
    def __init__(self, redis_url: str):
        self.redis = aioredis.from_url(redis_url)
    
    async def get(self, key: str):
        return await self.redis.get(key)
    
    async def set(self, key: str, value: str, expire: int = 3600):
        await self.redis.setex(key, expire, value)
    
    async def delete(self, key: str):
        await self.redis.delete(key)

class UserServiceWithCache:
    def __init__(self, db: DatabaseService, cache: RedisCache):
        self.db = db
        self.cache = cache
    
    async def get_user(self, user_id: int):
        cache_key = f"user:{user_id}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        cached_user = await self.cache.get(cache_key)
        if cached_user:
            return json.loads(cached_user)
        
        # –ï—Å–ª–∏ –Ω–µ—Ç –≤ –∫—ç—à–µ, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–∑ –ë–î
        async with self.db.get_connection() as conn:
            user = await conn.fetchrow("SELECT * FROM users WHERE id = $1", user_id)
            user_data = dict(user) if user else None
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
        if user_data:
            await self.cache.set(cache_key, json.dumps(user_data))
        
        return user_data
```

---

## ‚ùì –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏–µ

### 1. Circular Imports (—Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∏–º–ø–æ—Ä—Ç—ã)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# handlers/user.py
from handlers.admin import admin_router

# handlers/admin.py  
from handlers.user import user_router  # –û—à–∏–±–∫–∞ —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞!
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
# handlers/__init__.py
from .user import user_router
from .admin import admin_router

# bot.py
from handlers import user_router, admin_router
```

### 2. Memory Leaks (—É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# –ü–ª–æ—Ö–æ - —Ö—Ä–∞–Ω–∏–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ø–∞–º—è—Ç–∏
messages = []

@dp.message()
async def echo(message: types.Message):
    messages.append(message)  # –ü–∞–º—è—Ç—å –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ!
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –•–æ—Ä–æ—à–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –∫—ç—à
from collections import deque

messages = deque(maxlen=1000)  # –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 —Å–æ–æ–±—â–µ–Ω–∏–π

@dp.message()
async def echo(message: types.Message):
    messages.append(message)
```

### 3. Blocking Operations (–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# –ü–ª–æ—Ö–æ - –±–ª–æ–∫–∏—Ä—É—é—â–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
@dp.message(Command("download"))
async def cmd_download(message: types.Message):
    import requests
    response = requests.get("https://example.com/large-file.zip")  # –ë–ª–æ–∫–∏—Ä—É–µ—Ç!
    await message.answer("–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω")
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –•–æ—Ä–æ—à–æ - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
import aiohttp

@dp.message(Command("download"))
async def cmd_download(message: types.Message):
    async with aiohttp.ClientSession() as session:
        async with session.get("https://example.com/large-file.zip") as response:
            data = await response.read()
    await message.answer("–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω")
```

### 4. Improper Error Handling (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# –ü–ª–æ—Ö–æ - –Ω–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
@dp.message(Command("data"))
async def cmd_data(message: types.Message):
    user = await db.fetchrow("SELECT * FROM users WHERE id = $1", message.from_user.id)
    await message.answer(f"User: {user['name']}")  # –ú–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å KeyError!
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –•–æ—Ä–æ—à–æ - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
@dp.message(Command("data"))
async def cmd_data(message: types.Message):
    try:
        user = await db.fetchrow("SELECT * FROM users WHERE id = $1", message.from_user.id)
        if user:
            await message.answer(f"User: {user['name']}")
        else:
            await message.answer("User not found")
    except Exception as e:
        logging.error(f"Error in cmd_data: {e}")
        await message.answer("An error occurred")
```

---

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ú—ã –∏–∑—É—á–∏–ª–∏ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ aiogram 3.x, –∫–æ—Ç–æ—Ä—ã–µ —è–≤–ª—è—é—Ç—Å—è –æ—Å–Ω–æ–≤–æ–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –±–æ—Ç–æ–≤. –≠—Ç–∞ –≥–ª–∞–≤–∞ –±—ã–ª–∞ —Å–∞–º–æ–π –≤–∞–∂–Ω–æ–π –≤ –Ω–∞—à–µ–º —É—á–µ–±–Ω–∏–∫–µ, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —ç—Ç–∏—Ö –æ—Å–Ω–æ–≤ ‚Äî –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.

### –ß—Ç–æ –º—ã —É–∑–Ω–∞–ª–∏:

1. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ aiogram** ‚Äî –∫–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –∏–∑–Ω—É—Ç—Ä–∏
2. **Dispatcher** ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, —É–ø—Ä–∞–≤–ª—è—é—â–∏–π –≤—Å–µ–º –ø–æ—Ç–æ–∫–æ–º –æ–±—Ä–∞–±–æ—Ç–∫–∏
3. **Bot** ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Telegram API
4. **Router** ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–¥–∞ –≤ –±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö
5. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** ‚Äî –ø–æ—á–µ–º—É aiogram —Ç–∞–∫–æ–π –±—ã—Å—Ç—Ä—ã–π –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π
6. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞** ‚Äî –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –∫–æ–¥
7. **Dependency Injection** ‚Äî –∫–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å –≥–∏–±–∫–∏–µ –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã–µ —Å–∏—Å—Ç–µ–º—ã
8. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚Äî –∫–∞–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞ –¥–ª—è –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:

- **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å**: —Ä–∞–∑–¥–µ–ª—è–π—Ç–µ –∫–æ–¥ –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –º–æ–¥—É–ª–∏
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å**: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ async/await –≤–µ–∑–¥–µ
- **DI**: –≤–Ω–µ–¥—Ä—è–π—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏—Ö –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Å–æ–≤
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞**: —Å–ª–µ–¥—É–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–¥–∞
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –∏–∑–º–µ—Ä—è–π—Ç–µ, –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ, –∫—ç—à–∏—Ä—É–π—Ç–µ

### –ß—Ç–æ –¥–∞–ª—å—à–µ?

–¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –≤—ã –ø–æ–Ω–∏–º–∞–µ—Ç–µ –æ—Å–Ω–æ–≤—ã, –≤—ã –≥–æ—Ç–æ–≤—ã –∫ –∏–∑—É—á–µ–Ω–∏—é –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ–º:
- **–§–∏–ª—å—Ç—Ä—ã –∏ –º–∏–¥–ª–≤–∞—Ä–∏** (–≥–ª–∞–≤—ã 07-–§–∏–ª—å—Ç—Ä—ã-—Å–æ–±—ã—Ç–∏–π –∏ 08-–ú–∏–¥–ª–≤–∞—Ä–∏)
- **–ö–æ–Ω–µ—á–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç—ã (FSM)** (–≥–ª–∞–≤–∞ 10-–ö–æ–Ω–µ—á–Ω—ã–µ-–∞–≤—Ç–æ–º–∞—Ç—ã-FSM)
- **Webhook –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ** (–≥–ª–∞–≤–∞ 14-Webhook-–∏-—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ)
- **–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã** (–≥–ª–∞–≤–∞ 15-–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ-–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)

### –°–æ–≤–µ—Ç—ã –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏:

1. **–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç** —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–æ—É—Ç–µ—Ä—ã** –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
3. **–ü—Ä–∏–º–µ–Ω–∏—Ç–µ DI** –¥–ª—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
4. **–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ—Å—Ç—ã** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
5. **–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ** –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
6. **–ò–∑—É—á–∞–π—Ç–µ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥** aiogram –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è

### –ü–æ–ª–µ–∑–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã:

- [–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è aiogram](https://docs.aiogram.dev/)
- [–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ aiogram –Ω–∞ GitHub](https://github.com/aiogram/aiogram)
- [Python asyncio –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://docs.python.org/3/library/asyncio.html)
- [–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ Dependency Injection](06-dip.md)
- [–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ Python](https://peps.python.org/pep-0008/)

---

> üí° **–í–∞–∂–Ω–æ:** –≠—Ç–∞ –≥–ª–∞–≤–∞ ‚Äî —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –≤–∞—à–µ–≥–æ —É—Å–ø–µ—Ö–∞. –ù–µ —Ç–æ—Ä–æ–ø–∏—Ç–µ—Å—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–∏–º —Ç–µ–º–∞–º, –ø–æ–∫–∞ –Ω–µ –ø–æ–π–º–µ—Ç–µ –∫–∞–∂–¥—É—é –∫–æ–Ω—Ü–µ–ø—Ü–∏—é. –ü–µ—Ä–µ—á–∏—Ç—ã–≤–∞–π—Ç–µ, —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ, —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç—ã.

> ‚ö†Ô∏è **–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ:** –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ä–≥–∞–Ω–∏–∑—É–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞ –∏ –ø—Ä–∏–º–µ–Ω—è–π—Ç–µ Dependency Injection. –≠—Ç–æ —Å–¥–µ–ª–∞–µ—Ç –≤–∞—à –∫–æ–¥ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–º.

–¢–µ–ø–µ—Ä—å –≤—ã –≥–æ—Ç–æ–≤—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã—Ö, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã—Ö –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –±–æ—Ç–æ–≤ –Ω–∞ aiogram 3.x! –£–¥–∞—á–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ! üöÄ‚ú®